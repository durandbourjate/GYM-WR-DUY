<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>√úbungspool laden‚Ä¶</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400&family=DM+Mono:wght@400;500&display=swap');
:root{
--c-bg:#f0f2f5;--c-surface:#fff;--c-primary:#f89907;--c-primary-light:#ffb74d;
--c-accent:#e8a838;--c-accent-light:#fef3c7;--c-success:#16a34a;--c-success-bg:#f0fdf4;
--c-error:#dc2626;--c-error-bg:#fef2f2;--c-info:#2563eb;--c-info-bg:#eff6ff;
--c-text:#1e293b;--c-text-soft:#64748b;--c-border:#e2e8f0;--radius:10px;
--shadow-sm:0 1px 3px rgba(0,0,0,.06);--shadow-md:0 4px 12px rgba(0,0,0,.08);
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',system-ui,sans-serif;background:var(--c-bg);color:var(--c-text);line-height:1.6;min-height:100vh}
.app-header{background:linear-gradient(135deg,var(--c-primary),var(--c-primary-light));color:#fff;padding:20px 24px;position:sticky;top:0;z-index:100;box-shadow:0 2px 12px rgba(0,0,0,.15);display:flex;align-items:center;gap:16px}
.home-btn{display:flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:8px;background:rgba(255,255,255,.2);color:#fff;text-decoration:none;font-size:1.1rem;flex-shrink:0;transition:.15s}
.home-btn:hover{background:rgba(255,255,255,.35)}
.app-header h1{font-size:1.25rem;font-weight:700;letter-spacing:-.02em}
.app-header .meta{font-size:.8rem;opacity:.75;margin-top:2px}
.container{max-width:720px;margin:0 auto;padding:20px 16px 100px}
.screen{display:none}.screen.active{display:block}
.card{background:var(--c-surface);border-radius:var(--radius);padding:24px;margin-bottom:16px;box-shadow:var(--shadow-sm);border:1px solid var(--c-border)}
.card h2{font-size:1.05rem;font-weight:700;margin-bottom:14px;color:var(--c-text)}
.mode-cards{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:8px}
.mode-card{border:2px solid var(--c-border);border-radius:var(--radius);padding:16px;cursor:pointer;text-align:center;transition:.2s}
.mode-card:hover{border-color:var(--c-primary-light);background:#f8fafc}
.mode-card.active{border-color:var(--c-primary);background:var(--c-info-bg)}
.mode-card .mode-icon{font-size:1.8rem;margin-bottom:6px}
.mode-card .mode-title{font-weight:700;font-size:.95rem}
.mode-card .mode-desc{font-size:.78rem;color:var(--c-text-soft);margin-top:4px}
.chips{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
.chip{display:inline-flex;align-items:center;padding:6px 14px;border-radius:20px;font-size:.82rem;font-weight:500;cursor:pointer;border:2px solid var(--c-border);background:#fff;transition:.15s;user-select:none}
.chip:hover{border-color:var(--c-primary-light)}
.chip.active{background:var(--c-primary);color:#fff;border-color:var(--c-primary)}
.filter-count{font-family:'DM Mono',monospace;font-size:.95rem;font-weight:600;color:var(--c-text);margin-top:8px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 24px;border-radius:var(--radius);font-family:inherit;font-size:.95rem;font-weight:600;cursor:pointer;border:none;transition:.2s}
.btn-primary{background:var(--c-primary);color:#fff}.btn-primary:hover{background:var(--c-primary-light)}
.btn-primary:disabled{opacity:.4;cursor:not-allowed}
.btn-accent{background:var(--c-accent);color:#fff}.btn-accent:hover{filter:brightness(1.05)}
.btn-outline{background:transparent;border:2px solid var(--c-border);color:var(--c-text)}.btn-outline:hover{border-color:var(--c-primary);color:var(--c-primary)}
.btn-block{width:100%;justify-content:center}
.q-badges{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
.badge{font-size:.7rem;font-weight:600;padding:3px 10px;border-radius:12px;text-transform:uppercase;letter-spacing:.03em}
.badge-topic{background:var(--c-info-bg);color:var(--c-info)}
.badge-diff1{background:#f0fdf4;color:#16a34a}.badge-diff2{background:#fef3c7;color:#b45309}.badge-diff3{background:#fef2f2;color:#dc2626}
.badge-tax{background:#f3e8ff;color:#7c3aed}
.badge-type{background:#f1f5f9;color:#475569}
.filter-header{display:flex;align-items:center;gap:10px;margin-bottom:14px}
.filter-header h2{margin-bottom:0}
.toggle-all{font-family:inherit;font-size:.72rem;font-weight:600;padding:3px 10px;border-radius:12px;cursor:pointer;border:1.5px solid var(--c-border);background:var(--c-bg);color:var(--c-text-soft);transition:.15s;white-space:nowrap}
.toggle-all:hover{border-color:var(--c-primary);color:var(--c-primary)}
.multi-hint{font-size:.8rem;color:var(--c-primary);font-weight:600;margin-bottom:12px}
.mc-opt .opt-check{width:18px;height:18px;border:2px solid var(--c-border);border-radius:4px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:.7rem;transition:.15s}
.mc-opt.selected .opt-check{background:var(--c-info);border-color:var(--c-info);color:#fff}
.mc-opt.correct .opt-check{background:var(--c-success);border-color:var(--c-success);color:#fff}
.mc-opt.wrong .opt-check{background:var(--c-error);border-color:var(--c-error);color:#fff}
.mc-opt.multi-neutral .opt-check{background:var(--c-border);border-color:var(--c-border);color:var(--c-text-soft)}
.q-context{font-size:.9rem;line-height:1.65;margin-bottom:16px;padding:14px 16px;border-radius:var(--radius);background:var(--c-bg);border-left:4px solid var(--c-primary);color:var(--c-text);font-style:italic}
.q-context-label{font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--c-primary);margin-bottom:4px;font-style:normal}
.q-text{font-size:1rem;font-weight:500;margin-bottom:18px;line-height:1.65}
.q-img{margin-bottom:16px;text-align:center}
.q-img img{max-width:100%;height:auto;border-radius:var(--radius);border:1px solid var(--c-border);box-shadow:var(--shadow-sm);cursor:zoom-in}
.q-img img.zoomed{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);max-width:95vw;max-height:95vh;z-index:200;border-radius:0;box-shadow:0 0 0 9999px rgba(0,0,0,.7);cursor:zoom-out}
.q-img figcaption{font-size:.78rem;color:var(--c-text-soft);margin-top:6px;font-style:italic}
.ri-img{margin:8px 0;text-align:center}
.ri-img img{max-width:100%;max-height:200px;height:auto;border-radius:6px;border:1px solid var(--c-border)}
.mc-options{display:flex;flex-direction:column;gap:10px}
.mc-opt{display:flex;align-items:flex-start;gap:12px;padding:14px 16px;border:2px solid var(--c-border);border-radius:var(--radius);cursor:pointer;transition:.15s;background:#fff}
.mc-opt:hover{border-color:var(--c-primary-light);background:#f8fafc}
.mc-opt.selected{border-color:var(--c-info);background:var(--c-info-bg)}
.mc-opt.correct{border-color:var(--c-success);background:var(--c-success-bg)}
.mc-opt.wrong{border-color:var(--c-error);background:var(--c-error-bg)}
.mc-opt .opt-letter{font-family:'DM Mono',monospace;font-weight:700;font-size:.85rem;min-width:24px;height:24px;display:flex;align-items:center;justify-content:center;border-radius:50%;background:var(--c-border);color:var(--c-text-soft);flex-shrink:0}
.mc-opt.selected .opt-letter{background:var(--c-info);color:#fff}
.mc-opt.correct .opt-letter{background:var(--c-success);color:#fff}
.mc-opt.wrong .opt-letter{background:var(--c-error);color:#fff}
.mc-opt .opt-text{font-size:.92rem;line-height:1.5}
.tf-btns{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.tf-btn{padding:16px;border:2px solid var(--c-border);border-radius:var(--radius);text-align:center;font-weight:600;font-size:1rem;cursor:pointer;transition:.15s;background:#fff}
.tf-btn:hover{border-color:var(--c-primary-light)}.tf-btn.selected{border-color:var(--c-info);background:var(--c-info-bg)}
.tf-btn.correct{border-color:var(--c-success);background:var(--c-success-bg)}
.tf-btn.wrong{border-color:var(--c-error);background:var(--c-error-bg)}
.fill-input{border:none;border-bottom:2px solid var(--c-primary);background:var(--c-info-bg);padding:4px 8px;font-family:inherit;font-size:.92rem;font-weight:500;min-width:120px;outline:none;border-radius:4px 4px 0 0;transition:.2s}
.fill-input:focus{border-color:var(--c-accent);background:var(--c-accent-light)}
.fill-input.correct{border-color:var(--c-success);background:var(--c-success-bg)}
.fill-input.wrong{border-color:var(--c-error);background:var(--c-error-bg)}
.calc-rows{display:flex;flex-direction:column;gap:10px}
.calc-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.calc-row label{font-size:.9rem;flex:1;min-width:150px}
.calc-row input{width:100px;padding:8px 10px;border:2px solid var(--c-border);border-radius:6px;font-family:'DM Mono',monospace;font-size:.92rem;text-align:right;outline:none}
.calc-row input:focus{border-color:var(--c-primary)}
.calc-row .unit{font-size:.85rem;color:var(--c-text-soft);min-width:30px}
.calc-row input.correct{border-color:var(--c-success);background:var(--c-success-bg)}
.calc-row input.wrong{border-color:var(--c-error);background:var(--c-error-bg)}
.open-answer{width:100%;min-height:80px;padding:12px;border:2px solid var(--c-border);border-radius:var(--radius);font-family:inherit;font-size:.92rem;line-height:1.5;resize:vertical;outline:none;background:#fff}
.open-answer:focus{border-color:var(--c-primary)}
.open-sample{margin-top:12px;padding:14px;border-radius:var(--radius);background:var(--c-info-bg);border-left:4px solid var(--c-info);font-size:.9rem;line-height:1.6;display:none}
.open-sample.show{display:block}
.open-sample-title{font-weight:700;color:var(--c-info);margin-bottom:4px}
.open-self{display:flex;gap:10px;margin-top:12px;display:none}
.open-self.show{display:flex}
.open-self .btn{flex:1}
.sort-pool{display:flex;flex-wrap:wrap;gap:8px;min-height:48px;padding:12px;background:var(--c-bg);border-radius:var(--radius);margin-bottom:12px}
.sort-item{padding:8px 14px;border-radius:8px;font-size:.85rem;font-weight:500;cursor:pointer;transition:.2s;border:2px solid var(--c-border);background:#fff;user-select:none}
.sort-item:hover{border-color:var(--c-primary-light)}.sort-item.picked{border-color:var(--c-primary);background:var(--c-primary);color:#fff;box-shadow:0 0 0 3px color-mix(in srgb,var(--c-primary) 25%,transparent)}
.sort-cats{display:grid;gap:12px;margin-top:8px}
.sort-cat{border:2px dashed var(--c-border);border-radius:var(--radius);padding:12px;min-height:60px;transition:.2s}
.sort-cat:hover{border-color:var(--c-primary-light)}
/* Pulse-Hinweis wenn Item ausgew√§hlt ist */
.sort-cat.awaiting{border-color:var(--c-primary);border-style:solid;background:color-mix(in srgb,var(--c-primary) 5%,transparent)}
.sort-cat.active{border-color:var(--c-primary);background:color-mix(in srgb,var(--c-primary) 8%,transparent)}
.sort-cat-title{font-weight:700;font-size:.85rem;color:var(--c-text);margin-bottom:8px}
.sort-cat-items{display:flex;flex-wrap:wrap;gap:6px}
.sort-cat-item{padding:6px 12px;border-radius:6px;font-size:.82rem;font-weight:500;cursor:pointer;background:var(--c-primary);color:#fff;transition:.15s}
.sort-cat-item:hover{opacity:.85}
.sort-cat-item.correct-item{background:var(--c-success)}.sort-cat-item.wrong-item{background:var(--c-error)}
.feedback{margin-top:16px;padding:16px;border-radius:var(--radius);font-size:.9rem;line-height:1.6;display:none}
.feedback.show{display:block}
.feedback.correct{background:var(--c-success-bg);border-left:4px solid var(--c-success)}
.feedback.wrong{background:var(--c-error-bg);border-left:4px solid var(--c-error)}
.feedback-title{font-weight:700;margin-bottom:4px}
.quiz-actions{display:flex;gap:10px;margin-top:18px;flex-wrap:wrap}
.result-score{text-align:center;padding:24px;font-family:'DM Mono',monospace}
.result-score .big{font-size:2.8rem;font-weight:700;color:var(--c-text)}
.result-score .pct{font-size:1.4rem;color:var(--c-text-soft)}
.topic-results{display:flex;flex-direction:column;gap:8px;margin-top:12px}
.topic-row{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:8px;background:var(--c-bg)}
.topic-row .topic-name{flex:1;font-size:.88rem;font-weight:500}
.topic-row .topic-score{font-family:'DM Mono',monospace;font-weight:600;font-size:.85rem}
.topic-row .topic-bar{width:60px;height:6px;background:var(--c-border);border-radius:3px;overflow:hidden}
.topic-row .topic-bar-fill{height:100%;border-radius:3px}
.tg{background:var(--c-success)}.ty{background:var(--c-accent)}.tr{background:var(--c-error)}
.wrong-list{margin-top:12px}
.wrong-item{padding:14px;border-radius:var(--radius);margin-bottom:10px;background:var(--c-bg);border-left:3px solid var(--c-error)}
.wrong-item .wq{font-weight:600;font-size:.9rem;margin-bottom:4px}
.wrong-item .wa{font-size:.85rem;color:var(--c-text-soft);line-height:1.5}
.review-list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
.review-item{padding:14px;border-radius:var(--radius);background:var(--c-bg);border-left:3px solid var(--c-border)}
.review-item.ri-correct{border-left-color:var(--c-success)}
.review-item.ri-wrong{border-left-color:var(--c-error)}
.review-item.ri-skipped{border-left-color:var(--c-text-soft)}
.ri-header{display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap}
.ri-num{font-family:'DM Mono',monospace;font-weight:700;font-size:.8rem;color:var(--c-text-soft)}
.ri-icon{font-size:.9rem}
.ri-topic{font-size:.7rem;font-weight:600;padding:2px 8px;border-radius:10px;background:var(--c-info-bg);color:var(--c-info)}
.ri-question{font-weight:600;font-size:.9rem;margin-bottom:8px;line-height:1.5}
.ri-answer{font-size:.85rem;line-height:1.5;color:var(--c-text)}
.ri-answer strong{font-weight:600}
.ri-explain{font-size:.82rem;color:var(--c-text-soft);margin-top:6px;line-height:1.5;padding-top:6px;border-top:1px solid var(--c-border)}
.ri-context{font-size:.82rem;font-style:italic;color:var(--c-text-soft);margin-bottom:6px;padding:8px 10px;background:var(--c-bg);border-left:3px solid var(--c-primary);border-radius:4px;line-height:1.5}
/* Loading screen */
.loading{text-align:center;padding:60px 20px}
.loading .spinner{width:40px;height:40px;border:4px solid var(--c-border);border-top-color:var(--c-primary);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 16px}
@keyframes spin{to{transform:rotate(360deg)}}
.loading .msg{color:var(--c-text-soft);font-size:.95rem}
.error{text-align:center;padding:60px 20px;color:var(--c-error)}
.error h2{margin-bottom:8px}
html.dark{
--c-bg:#0f1117;--c-surface:#1a1d27;--c-primary:#f89907;--c-primary-light:#ffb74d;
--c-accent:#e8a838;--c-accent-light:#3d2e10;--c-success:#22c55e;--c-success-bg:#0a2618;
--c-error:#ef4444;--c-error-bg:#2a0f0f;--c-info:#60a5fa;--c-info-bg:#0f1d3a;
--c-text:#e2e8f0;--c-text-soft:#94a3b8;--c-border:#2d3348;
--shadow-sm:0 1px 3px rgba(0,0,0,.3);--shadow-md:0 4px 12px rgba(0,0,0,.4);
}
html.dark .app-header{box-shadow:0 2px 12px rgba(0,0,0,.4)}
html.dark .mc-opt,html.dark .tf-btn,html.dark .sort-item{background:var(--c-surface)}
html.dark .mc-opt:hover,html.dark .mode-card:hover{background:#1f2333}
html.dark .mc-opt .opt-letter{background:var(--c-border);color:var(--c-text-soft)}
html.dark .chip{background:var(--c-surface)}
html.dark .toggle-all{background:var(--c-surface);border-color:var(--c-border)}
html.dark .badge-diff1{background:#0a2618;color:#22c55e}html.dark .badge-diff2{background:#3d2e10;color:#e8a838}html.dark .badge-diff3{background:#2a0f0f;color:#ef4444}
html.dark .badge-progress{background:#3d2e10;color:#e8a838}html.dark .badge-score{background:#0a2618;color:#22c55e}
html.dark .badge-tax{background:#1a0f2e;color:#a78bfa}
html.dark .badge-type{background:#1a1d27;color:#94a3b8}
html.dark .topic-row{background:var(--c-surface)}
html.dark .wrong-item{background:var(--c-surface)}
html.dark .review-item{background:var(--c-surface)}
html.dark .q-context{background:var(--c-surface);border-left-color:var(--c-primary);color:var(--c-text)}
html.dark .ri-context{background:var(--c-surface);border-left-color:var(--c-primary)}
html.dark .calc-row input{background:var(--c-surface);color:var(--c-text);border-color:var(--c-border)}
html.dark .open-answer{background:var(--c-surface);color:var(--c-text);border-color:var(--c-border)}
html.dark .fill-input{background:var(--c-surface);color:var(--c-text);border-color:var(--c-primary)}
html.dark .fill-input:focus{background:var(--c-accent-light);color:var(--c-text)}
html.dark .fill-input.correct{background:var(--c-success-bg);color:var(--c-text)}
html.dark .fill-input.wrong{background:var(--c-error-bg);color:var(--c-text)}
@media print{
html.dark{--c-bg:#f0f2f5;--c-surface:#fff;--c-text:#1e293b;--c-text-soft:#64748b;--c-border:#e2e8f0;--c-success:#16a34a;--c-error:#dc2626;--c-info:#2563eb;--c-info-bg:#eff6ff}
body{min-height:auto!important;background:#fff!important}
.container{padding:0 16px!important;max-width:100%!important}
.app-header,.quiz-actions,#startScreen,#loadingScreen,#errorScreen,#quizScreen,#infoScreen{display:none!important;height:0!important;overflow:hidden!important;padding:0!important;margin:0!important}
#resultScreen{display:block!important}
#resultScreen .btn{display:none!important}
.card{break-inside:avoid;page-break-inside:avoid;box-shadow:none;border:1px solid #ccc;background:#fff!important}
.print-header{display:block!important;text-align:center;padding:16px 0 8px;border-bottom:2px solid #333;margin-bottom:16px}
.print-header h1{font-size:1.3rem;font-weight:700;margin:0}.print-header .print-meta{font-size:.8rem;color:#666;margin-top:4px}
.review-item{break-inside:avoid;page-break-inside:avoid;border:1px solid #ddd;border-left:3px solid #999;background:#fff!important}
.review-item.ri-correct{border-left-color:#16a34a}
.review-item.ri-wrong{border-left-color:#dc2626}
.ri-img img{max-height:150px}
.q-img img.zoomed{position:static!important;transform:none!important;box-shadow:none!important;max-height:200px}
.ri-topic{border:1px solid #ccc}
.ri-context{background:#f5f5f5!important;border-left-color:#999}
.topic-row{background:#f5f5f5!important}
.topic-bar{print-color-adjust:exact;-webkit-print-color-adjust:exact}
.topic-bar-fill{print-color-adjust:exact;-webkit-print-color-adjust:exact}
}
.print-header{display:none}
.info-row{display:flex;align-items:stretch;gap:10px;margin-bottom:10px;flex-wrap:wrap}
.info-row .info-topic{flex:1;min-width:150px}
.info-row .info-topic-label{font-weight:600;font-size:.9rem}
.info-row .info-topic-key{font-family:'DM Mono',monospace;font-size:.75rem;color:var(--c-text-soft)}
.info-row .info-topic-count{font-size:.78rem;color:var(--c-text-soft)}
.info-link-box{flex:2;min-width:200px;position:relative}
.info-link-input{width:100%;padding:8px 36px 8px 10px;border:2px solid var(--c-border);border-radius:6px;font-family:'DM Mono',monospace;font-size:.78rem;background:var(--c-bg);color:var(--c-text);outline:none;cursor:text}
.info-link-input:focus{border-color:var(--c-primary)}
.info-copy-btn{position:absolute;right:4px;top:50%;transform:translateY(-50%);background:none;border:none;font-size:1rem;cursor:pointer;padding:4px 6px;border-radius:4px;opacity:.6;transition:.15s}
.info-copy-btn:hover{opacity:1;background:var(--c-border)}
.info-copy-btn.copied{opacity:1}
.q-card{position:relative;overflow:hidden;padding-top:28px}
.q-progress-bar{position:absolute;top:0;left:0;height:4px;background:var(--c-accent);transition:width .4s ease;border-radius:0 2px 2px 0;z-index:1}
.q-progress-bg{position:absolute;top:0;left:0;right:0;height:4px;background:var(--c-border)}
.badge-progress{background:var(--c-accent-light);color:var(--c-accent);margin-left:auto}
.badge-score{background:var(--c-success-bg);color:var(--c-success)}
.q-action-row{display:flex;gap:10px;margin-top:14px;align-items:stretch}
.q-action-row .btn{flex:none;min-height:44px;display:inline-flex;align-items:center}
.q-action-row .btn-skip{margin-left:auto}
.btn-skip{background:transparent;border:2px solid var(--c-primary);color:var(--c-primary);font-size:.85rem;padding:10px 18px;min-height:44px;box-sizing:border-box}
.btn-skip:hover{background:color-mix(in srgb,var(--c-primary) 10%,transparent)}
.q-bottom-row{display:flex;justify-content:space-between;align-items:center;margin-top:16px;padding-top:14px;border-top:1px solid var(--c-border)}
.btn-end{background:none;border:none;color:var(--c-text-soft);font-size:.78rem;cursor:pointer;padding:4px 8px;border-radius:6px;transition:.15s;font-family:inherit}
.btn-end:hover{background:var(--c-bg);color:var(--c-text)}
.btn-report{background:none;border:none;color:var(--c-text-soft);font-size:.78rem;cursor:pointer;padding:4px 8px;border-radius:6px;transition:.15s;font-family:inherit}
.btn-report:hover{background:var(--c-bg);color:var(--c-text)}
/* ‚ïê‚ïê‚ïê REPORT MODAL ‚ïê‚ïê‚ïê */
.report-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:300;display:none;align-items:center;justify-content:center;padding:16px}
.report-overlay.active{display:flex}
.report-modal{background:var(--c-surface);border-radius:var(--radius);max-width:440px;width:100%;box-shadow:0 8px 32px rgba(0,0,0,.2);overflow:hidden;animation:reportSlide .2s ease}
@keyframes reportSlide{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.report-modal-header{padding:16px 20px;border-bottom:1px solid var(--c-border);display:flex;align-items:center;justify-content:space-between}
.report-modal-header h3{font-size:1rem;font-weight:700}
.report-modal-close{background:none;border:none;font-size:1.3rem;cursor:pointer;color:var(--c-text-soft);padding:4px 8px;border-radius:6px;line-height:1}
.report-modal-close:hover{background:var(--c-bg);color:var(--c-text)}
.report-modal-body{padding:20px}
.report-meta{font-size:.78rem;color:var(--c-text-soft);margin-bottom:16px;padding:10px 12px;background:var(--c-bg);border-radius:8px;line-height:1.6}
.report-meta strong{color:var(--c-text);font-weight:600}
.report-label{font-size:.85rem;font-weight:600;margin-bottom:8px;color:var(--c-text)}
.report-cats{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px}
.report-cat{padding:8px 14px;border-radius:20px;font-size:.82rem;font-weight:500;cursor:pointer;border:2px solid var(--c-border);background:var(--c-surface);transition:.15s;user-select:none}
.report-cat:hover{border-color:var(--c-primary-light)}
.report-cat.active{background:var(--c-primary);color:#fff;border-color:var(--c-primary)}
.report-textarea{width:100%;min-height:70px;padding:10px 12px;border:2px solid var(--c-border);border-radius:8px;font-family:inherit;font-size:.88rem;line-height:1.5;resize:vertical;outline:none;background:var(--c-surface);color:var(--c-text)}
.report-textarea:focus{border-color:var(--c-primary)}
.report-textarea::placeholder{color:var(--c-text-soft)}
.report-actions{display:flex;gap:10px;margin-top:16px}
.report-actions .btn{flex:1}
.report-success{text-align:center;padding:24px 20px}
.report-success .success-icon{font-size:2rem;margin-bottom:8px}
.report-success p{font-size:.9rem;color:var(--c-text-soft)}
.report-error{font-size:.82rem;color:var(--c-error);margin-top:8px;display:none}
html.dark .report-modal{background:var(--c-surface)}
html.dark .report-meta{background:var(--c-bg)}
html.dark .report-cat{background:var(--c-surface)}
html.dark .report-textarea{background:var(--c-bg);border-color:var(--c-border);color:var(--c-text)}
html.dark .mode-card{background:var(--c-surface)}
html.dark .mode-card.active{background:var(--c-info-bg)}
.theme-toggle{display:flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:8px;background:rgba(255,255,255,.2);border:none;color:#fff;font-size:1.15rem;cursor:pointer;flex-shrink:0;transition:.15s;padding:0;line-height:1}
.theme-toggle:hover{background:rgba(255,255,255,.35)}
.hints-container{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0;padding:12px;background:var(--c-info-bg);border-radius:var(--radius);border:1px dashed var(--c-border);align-items:flex-start}
.fill-hints{flex-wrap:wrap;align-items:center}
.fill-hint-label{font-size:.78rem;color:var(--c-info);font-weight:600;width:100%;margin-bottom:4px}
.fill-hint-word{padding:5px 12px;border-radius:16px;font-size:.85rem;font-weight:500;background:var(--c-surface);border:1px solid var(--c-border);color:var(--c-text)}
.text-hints{flex-direction:column;align-items:stretch}
.text-hints-label{font-size:.78rem;color:var(--c-info);font-weight:600;width:100%;margin-bottom:8px}
.text-hint-item{font-size:.9rem;color:var(--c-text);line-height:1.5;margin-bottom:4px}
.text-hint-item:last-child{margin-bottom:0}
.btn-back{background:transparent;border:2px solid var(--c-border);color:var(--c-text-soft);font-size:.85rem;padding:10px 18px;border-radius:var(--radius);font-family:inherit;font-weight:600;cursor:pointer;transition:.2s;display:inline-flex;align-items:center;gap:6px;min-height:44px;box-sizing:border-box}
.btn-back:hover{border-color:var(--c-primary);color:var(--c-primary);background:color-mix(in srgb,var(--c-primary) 8%,transparent)}
.kbd-hint{font-size:.72rem;color:var(--c-text-soft);text-align:center;margin-top:8px;opacity:.6}
.kbd-hint kbd{background:var(--c-bg);border:1px solid var(--c-border);border-radius:4px;padding:1px 6px;font-family:'DM Mono',monospace;font-size:.7rem}
/* ‚ïê‚ïê‚ïê MOBILE RESPONSIVE ‚ïê‚ïê‚ïê */
@media(max-width:600px){
  /* Container & Cards */
  .container{padding:12px 10px 80px}
  .card{padding:16px 14px}
  .mode-cards{grid-template-columns:1fr}
  .tf-btns{grid-template-columns:1fr}
  .kbd-hint{display:none}

  /* ‚îÄ‚îÄ Badges kompakter ‚îÄ‚îÄ */
  .q-badges{gap:4px;margin-bottom:10px}
  .badge{font-size:.62rem;padding:2px 7px;letter-spacing:.02em}
  .badge-progress,.badge-score{font-size:.68rem}
  /* Typ-Badge auf Mobile ausblenden (spart Platz, Typ ist aus Aufgabe erkennbar) */
  .badge-type{display:none}

  /* ‚îÄ‚îÄ Frage-Text ‚îÄ‚îÄ */
  .q-text{font-size:.93rem;margin-bottom:14px}
  .q-context{font-size:.84rem;padding:10px 12px}

  /* ‚îÄ‚îÄ Zuordnungs-Aufgaben: Kategorien vertikal stapeln ‚îÄ‚îÄ */
  .sort-cats{grid-template-columns:1fr!important;gap:10px}
  .sort-cat{min-height:48px;padding:10px}
  .sort-cat-title{font-size:.82rem}
  .sort-pool{padding:10px;gap:6px}
  .sort-item{padding:7px 12px;font-size:.82rem}
  .sort-cat-item{padding:5px 10px;font-size:.8rem}

  /* ‚îÄ‚îÄ Aktions-Buttons: Flexbox mit Wrap ‚îÄ‚îÄ */
  .q-action-row{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-top:14px;
  }
  .q-action-row .btn{
    font-size:.82rem;
    padding:10px 12px;
    min-height:44px;
    white-space:nowrap;
    justify-content:center;
  }
  /* Tipps (L√ºckentext): links, Reihe 1 */
  .q-action-row .btn-outline{order:1;flex:1 1 calc(50% - 4px)}
  /* √úberpr√ºfen: volle Breite, ABER neben Tipps wenn vorhanden */
  .q-action-row .btn-primary{order:2;flex:1 1 100%}
  .q-action-row .btn-outline ~ .btn-primary{flex:1 1 calc(50% - 4px)}
  /* Zur√ºck + √úberspringen: nebeneinander, Reihe 2 */
  .q-action-row .btn-back{order:10;flex:1 1 calc(50% - 4px)}
  .q-action-row .btn-skip{order:11;flex:1 1 calc(50% - 4px);margin-left:0}
  /* N√§chste Aufgabe: gleicher Platz wie √úberspringen */
  .q-action-row .btn-accent{order:11;flex:1 1 calc(50% - 4px);margin-left:0}

  /* ‚îÄ‚îÄ Bottom Row: gr√∂ssere Touch-Targets ‚îÄ‚îÄ */
  .q-bottom-row{
    margin-top:12px;
    padding-top:12px;
  }
  .btn-end,.btn-report{
    min-height:44px;
    padding:8px 12px;
    font-size:.8rem;
    display:inline-flex;
    align-items:center;
  }

  /* ‚îÄ‚îÄ MC-Optionen kompakter ‚îÄ‚îÄ */
  .mc-opt{padding:11px 12px;gap:10px}
  .mc-opt .opt-text{font-size:.88rem}
  .mc-opt .opt-letter{min-width:22px;height:22px;font-size:.8rem}

  /* ‚îÄ‚îÄ Calc-Rows ‚îÄ‚îÄ */
  .calc-row{gap:8px}
  .calc-row label{font-size:.85rem;min-width:0;flex:1 1 100%}
  .calc-row input{width:80px;padding:8px;font-size:.88rem}

  /* ‚îÄ‚îÄ Fill-Input ‚îÄ‚îÄ */
  .fill-input{min-width:90px;font-size:.88rem;padding:5px 8px}

  /* ‚îÄ‚îÄ Result Screen ‚îÄ‚îÄ */
  .result-score .big{font-size:2.2rem}
  .result-score .pct{font-size:1.2rem}

  /* ‚îÄ‚îÄ Feedback ‚îÄ‚îÄ */
  .feedback{padding:12px;font-size:.85rem;margin-top:12px}

  /* ‚îÄ‚îÄ Chips ‚îÄ‚îÄ */
  .chips{gap:6px}
  .chip{padding:5px 11px;font-size:.78rem}

  /* ‚îÄ‚îÄ Filter-Header ‚îÄ‚îÄ */
  .filter-header h2{font-size:.95rem}

  /* ‚îÄ‚îÄ Hints Container ‚îÄ‚îÄ */
  .hints-container{padding:10px;gap:6px}
  .fill-hints{gap:6px}
  .fill-hint-word{padding:4px 10px;font-size:.82rem}
  .text-hint-item{font-size:.85rem}
}
/* ‚ïê‚ïê‚ïê KOMPAKTER HEADER beim Scrollen (Mobile) ‚ïê‚ïê‚ïê */
.app-header{transition:padding .25s ease}
.app-header .meta{transition:font-size .25s ease,margin-top .25s ease,opacity .25s ease,max-height .25s ease;overflow:hidden;max-height:2em}
.app-header h1{transition:font-size .25s ease}
.app-header.compact{padding:8px 16px}
.app-header.compact h1{font-size:.95rem}
.app-header.compact .meta{max-height:0;opacity:0;margin-top:0;font-size:0}
.app-header.compact .home-btn,.app-header.compact .theme-toggle,.app-header.compact .header-lz-btn{width:30px;height:30px;font-size:.95rem}

/* ‚ïê‚ïê‚ïê LERNZIELE ‚Äî üèÅ im Chip ‚ïê‚ïê‚ïê */
.chip-lz{display:inline-flex;align-items:center;justify-content:center;width:auto;height:auto;background:none;border:none;font-size:.6rem;cursor:pointer;transition:.15s;flex-shrink:0;margin-left:3px;margin-right:-4px;padding:0}
.chip-lz:hover{transform:scale(1.2)}
/* ‚ïê‚ïê‚ïê LERNZIELE ‚Äî Mini-Modal (Topic-Lernziele, zentriert) ‚ïê‚ïê‚ïê */
.lz-mini-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:400;display:none;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(3px);-webkit-backdrop-filter:blur(3px)}
.lz-mini-overlay.active{display:flex}
.lz-mini-modal{background:var(--c-surface);border-radius:14px;max-width:420px;width:100%;max-height:70vh;display:flex;flex-direction:column;box-shadow:0 16px 48px rgba(0,0,0,.18);animation:lzPop .2s ease}
@keyframes lzPop{from{transform:scale(.95);opacity:0}to{transform:scale(1);opacity:1}}
.lz-mini-header{display:flex;align-items:center;gap:10px;padding:16px 20px 12px;border-bottom:1px solid var(--c-border)}
.lz-mini-header .lz-color-dot{width:10px;height:10px;border-radius:50%;background:var(--c-pool);flex-shrink:0}
.lz-mini-header h3{font-size:.95rem;font-weight:700;flex:1}
.lz-mini-close{background:none;border:none;font-size:1.2rem;cursor:pointer;color:var(--c-text-soft);padding:2px 6px;border-radius:6px;transition:.15s;line-height:1}
.lz-mini-close:hover{background:var(--c-border);color:var(--c-text)}
.lz-mini-body{overflow-y:auto;padding:14px 20px 18px}
/* ‚ïê‚ïê‚ïê LERNZIELE ‚Äî Lernziel-Liste (shared) ‚ïê‚ïê‚ïê */
.lz-list{list-style:none;padding:0}
.lz-list li{position:relative;padding:7px 0 7px 22px;font-size:.88rem;line-height:1.5;border-bottom:1px solid var(--c-border)}
.lz-list li:last-child{border-bottom:none}
.lz-list li::before{content:'üèÅ';position:absolute;left:0;top:7px;font-size:.72rem}
.lz-tax{font-family:'DM Mono',monospace;font-size:.68rem;background:var(--c-border);color:var(--c-text-soft);padding:1px 6px;border-radius:4px;margin-left:4px;white-space:nowrap}
/* ‚ïê‚ïê‚ïê LERNZIELE ‚Äî Vollst√§ndiges Modal (Header-Button) ‚ïê‚ïê‚ïê */
.lz-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:500;display:none;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px)}
.lz-overlay.active{display:flex}
.lz-modal{background:var(--c-surface);border-radius:16px;max-width:600px;width:100%;max-height:80vh;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,.2);animation:lzSlideUp .25s ease}
@keyframes lzSlideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
.lz-modal-header{display:flex;align-items:center;justify-content:space-between;padding:20px 24px 16px;border-bottom:1px solid var(--c-border)}
.lz-modal-header h2{font-size:1.1rem;font-weight:700;display:flex;align-items:center;gap:8px}
.lz-modal-close{background:none;border:none;font-size:1.3rem;cursor:pointer;color:var(--c-text-soft);padding:4px 8px;border-radius:6px;transition:.15s;line-height:1}
.lz-modal-close:hover{background:var(--c-border);color:var(--c-text)}
.lz-modal-body{overflow-y:auto;padding:20px 24px 24px;flex:1}
.lz-pool-section{margin-bottom:20px}
.lz-pool-section h3,.lz-topic-section h3{font-size:.85rem;font-weight:600;color:var(--c-text-soft);text-transform:uppercase;letter-spacing:.04em;margin-bottom:10px}
.lz-topic-section{margin-top:16px}
.lz-topic{background:var(--c-bg);border-radius:var(--radius);margin-bottom:8px;overflow:hidden;border:1px solid var(--c-border)}
.lz-topic-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;cursor:pointer;transition:background .15s;gap:8px}
.lz-topic-header:hover{background:var(--c-border)}
.lz-topic-label{font-size:.9rem;font-weight:600;flex:1}
.lz-topic-badge{font-family:'DM Mono',monospace;font-size:.72rem;background:var(--c-primary);color:#fff;padding:4px 10px;border-radius:99px;white-space:nowrap;cursor:pointer;transition:.15s;border:none;font-weight:600}
.lz-topic-badge:hover{filter:brightness(1.15);transform:scale(1.05)}
.lz-topic-chevron{font-size:.75rem;color:var(--c-text-soft);transition:transform .2s}
.lz-topic.open .lz-topic-chevron{transform:rotate(90deg)}
.lz-topic-body{max-height:0;overflow:hidden;transition:max-height .25s ease}
.lz-topic.open .lz-topic-body{max-height:500px}
.lz-topic-body .lz-list{padding:0 16px 12px}
/* ‚ïê‚ïê‚ïê LERNZIELE ‚Äî Header-Button ‚ïê‚ïê‚ïê */
.header-lz-btn{display:flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:8px;background:rgba(255,255,255,.2);border:none;color:#fff;font-size:1.05rem;cursor:pointer;flex-shrink:0;transition:.15s;padding:0;line-height:1}
.header-lz-btn:hover{background:rgba(255,255,255,.35)}
@media(max-width:500px){.lz-mini-modal{max-width:calc(100vw - 32px)}}
/* ‚ïê‚ïê‚ïê LERNZIELE ‚Äî Klickbare Items (Quiz starten) ‚ïê‚ïê‚ïê */
.lz-topic-start{display:flex;align-items:center;gap:8px;margin:0 16px 12px;padding:8px 14px;border-radius:8px;background:var(--c-primary);color:#fff;border:none;font-family:inherit;font-size:.82rem;font-weight:600;cursor:pointer;transition:.15s;width:calc(100% - 32px)}
.lz-topic-start:hover{filter:brightness(1.1);transform:translateY(-1px)}
.lz-topic-start .lz-start-icon{font-size:.9rem}
html.dark .lz-topic-start{background:var(--c-primary)}
/* ‚ïê‚ïê‚ïê SUCHFELD + START ‚Äî Nebeneinander ‚ïê‚ïê‚ïê */
.start-top-row{display:flex;gap:12px;align-items:stretch}
.start-search-col{flex:1;min-width:0;display:flex;flex-direction:column}
.start-search-col > div:first-child{flex-shrink:0}
.start-btn-top{flex-shrink:0;min-width:140px;white-space:nowrap;height:auto}
.card > .filter-count{font-family:'DM Mono',monospace;font-size:.82rem;font-weight:600;color:var(--c-text-soft);text-align:center;margin-top:8px}
@media(max-width:500px){
  .start-top-row{flex-direction:column}
  .start-btn-top{width:100%}
}
/* ‚ïê‚ïê‚ïê HILFE-MODAL ‚ïê‚ïê‚ïê */
.help-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:600;display:none;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px)}
.help-overlay.active{display:flex}
.help-modal{background:var(--c-surface);border-radius:16px;max-width:560px;width:100%;max-height:80vh;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,.2);overflow:hidden;animation:lzSlideUp .25s ease}
.help-modal-header{display:flex;align-items:center;justify-content:space-between;padding:20px 24px 16px;border-bottom:1px solid var(--c-border)}
.help-modal-header h2{font-size:1.1rem;font-weight:700}
.help-modal-close{background:none;border:none;font-size:1.3rem;cursor:pointer;color:var(--c-text-soft);padding:4px 8px;border-radius:6px;transition:.15s;line-height:1}
.help-modal-close:hover{background:var(--c-border);color:var(--c-text)}
.help-modal-body{overflow-y:auto;padding:20px 24px 24px;flex:1;-webkit-overflow-scrolling:touch;overscroll-behavior:contain}
.help-section{margin-bottom:16px}
.help-section h4{font-size:.92rem;font-weight:700;margin-bottom:6px;color:var(--c-primary,var(--c-pool,#f89907))}
.help-section p{font-size:.88rem;line-height:1.6;margin-bottom:6px}
.help-section ul{list-style:none;padding:0;margin:0}
.help-section li{font-size:.86rem;line-height:1.6;padding:3px 0 3px 18px;position:relative}
.help-section li::before{content:'¬∑';position:absolute;left:4px;font-weight:700;color:var(--c-text-soft)}
.help-section kbd{display:inline-block;padding:1px 6px;border-radius:4px;font-family:'DM Mono',monospace;font-size:.78rem;background:var(--c-bg);border:1px solid var(--c-border)}

/* ‚ïê‚ïê‚ïê SUCHFELD ‚Äî Startscreen ‚ïê‚ïê‚ïê */
.search-card{position:relative}
.search-input{width:100%;padding:10px 14px 10px 38px;border:2px solid var(--c-border);border-radius:var(--radius);font-family:inherit;font-size:.9rem;outline:none;background:var(--c-surface);color:var(--c-text);transition:.2s}
.search-input:focus{border-color:var(--c-primary);box-shadow:0 0 0 3px color-mix(in srgb,var(--c-primary) 15%,transparent)}
.search-input::placeholder{color:var(--c-text-soft)}
.search-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:1rem;color:var(--c-text-soft);pointer-events:none}
.search-clear{position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;font-size:1.1rem;cursor:pointer;color:var(--c-text-soft);padding:2px 6px;border-radius:4px;display:none}
.search-clear:hover{background:var(--c-border);color:var(--c-text)}
.search-results{font-size:.82rem;color:var(--c-text-soft);margin-top:8px;display:none}
.search-results.active{display:block}
.search-tag-chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.search-tag{font-size:.72rem;font-weight:600;padding:3px 10px;border-radius:12px;cursor:pointer;border:1.5px solid var(--c-border);background:var(--c-surface);color:var(--c-text-soft);transition:.15s}
.search-tag:hover{border-color:var(--c-primary);color:var(--c-primary)}
.search-tag.active{background:var(--c-primary);color:#fff;border-color:var(--c-primary)}
.search-tag.tag-bne{border-color:#16a34a;color:#16a34a}.search-tag.tag-bne.active{background:#16a34a;color:#fff}
.search-tag.tag-idz{border-color:#7c3aed;color:#7c3aed}.search-tag.tag-idz.active{background:#7c3aed;color:#fff}
.search-tag.tag-dig{border-color:#2563eb;color:#2563eb}.search-tag.tag-dig.active{background:#2563eb;color:#fff}
.search-tag.tag-pol{border-color:#dc2626;color:#dc2626}.search-tag.tag-pol.active{background:#dc2626;color:#fff}
html.dark .search-input{background:var(--c-surface);border-color:var(--c-border)}
html.dark .search-tag{background:var(--c-surface)}
</style>
<script>
// Theme sofort anwenden (vor Render, verhindert Flackern)
(function(){
  var saved=localStorage.getItem('pool-theme');
  var isDark=saved==='dark'||(saved===null&&window.matchMedia('(prefers-color-scheme:dark)').matches);
  if(isDark)document.documentElement.classList.add('dark');
})();
</script>
</head>
<body>
<header class="app-header">
<div style="flex:1;min-width:0">
<h1 id="poolTitle">√úbungspool laden‚Ä¶</h1>
<div class="meta" id="poolMeta">Gymnasium Hofwil ¬∑ Individuell √ºben</div>
</div>
<div style="display:flex;align-items:center;gap:8px;flex-shrink:0">
<a href="index.html" class="home-btn" title="Zur √úbersicht">üè†</a>
<button class="header-lz-btn" onclick="toggleFullModal()" title="Alle Lernziele" id="headerLzBtn" style="display:none">üèÅ</button>
<button class="theme-toggle" onclick="openHelp()" title="Anleitung" aria-label="Anleitung anzeigen">?</button>
<button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Light/Dark Mode wechseln" aria-label="Farbmodus wechseln">üåô</button>
</div>
</header>
<div class="container">

<!-- ‚ïê‚ïê‚ïê Loading ‚ïê‚ïê‚ïê -->
<div id="loadingScreen" class="screen active">
<div class="card loading">
<div class="spinner"></div>
<div class="msg">√úbungspool wird geladen‚Ä¶</div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê Error ‚ïê‚ïê‚ïê -->
<div id="errorScreen" class="screen">
<div class="card error">
<h2>‚ö†Ô∏è Pool nicht gefunden</h2>
<p id="errorMsg">Der gew√ºnschte √úbungspool konnte nicht geladen werden.</p>
<p style="margin-top:12px"><a href="index.html">‚Üê Zur √úbersicht</a></p>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê Info / Deep-Link-√úbersicht ‚ïê‚ïê‚ïê -->
<div id="infoScreen" class="screen">
<div class="card">
<h2>üîó Deep-Link-√úbersicht</h2>
<p style="font-size:.88rem;color:var(--c-text-soft);margin-bottom:16px;line-height:1.6">Kopiere diese Links, um in LearningView direkt auf ein Unterthema zu verlinken. Mit <code style="background:var(--c-bg);padding:2px 6px;border-radius:4px;font-size:.82rem">&amp;start=1</code> am Ende startet das Quiz automatisch.</p>
<div id="infoLinks"></div>
</div>
<div class="card" style="text-align:center">
<button class="btn btn-primary" onclick="document.getElementById('infoScreen').classList.remove('active');document.getElementById('startScreen').classList.add('active')">‚Üí Zum √úbungspool</button>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê Startbildschirm ‚ïê‚ïê‚ïê -->
<div id="startScreen" class="screen">
<div class="card">
<div class="start-top-row">
<div class="start-search-col">
<div style="position:relative" id="searchCard">
<span class="search-icon">üîç</span>
<input class="search-input" id="searchInput" type="text" placeholder="Stichwort suchen‚Ä¶" oninput="onSearchInput(this.value)" autocomplete="off">
<button class="search-clear" id="searchClear" onclick="clearSearch()">&times;</button>
</div>
<div class="search-results" id="searchResults"></div>
<div class="search-tag-chips" id="transversalChips"></div>
</div>
<button class="btn btn-primary start-btn-top" id="startBtn" onclick="startQuiz()" disabled>√úbung starten</button>
</div>
<div class="filter-count" id="filterCount">0 Aufgaben verf√ºgbar</div>
</div>
<div class="card">
<div class="filter-header"><h2>üìö Unterthema</h2><button class="toggle-all" onclick="toggleAll('topicChips','topics')">Alle ‚áÑ</button></div>
<div class="chips" id="topicChips"></div>
</div>
<div class="card">
<div class="filter-header"><h2>üìä Schwierigkeit</h2><button class="toggle-all" onclick="toggleAll('diffChips','diffs')">Alle ‚áÑ</button></div>
<div class="chips" id="diffChips"></div>
</div>
<div class="card">
<div class="filter-header"><h2>‚úèÔ∏è Fragetyp</h2><button class="toggle-all" onclick="toggleAll('typeChips','types')">Alle ‚áÑ</button></div>
<div class="chips" id="typeChips"></div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê Quiz-Bildschirm ‚ïê‚ïê‚ïê -->
<div id="quizScreen" class="screen">
<div class="card q-card" id="questionCard"></div>
</div>

<!-- ‚ïê‚ïê‚ïê Ergebnis ‚ïê‚ïê‚ïê -->
<div id="resultScreen" class="screen">
<div class="print-header"><h1 id="printTitle"></h1><div class="print-meta" id="printMeta"></div></div>
<div class="card">
<div class="result-score">
<div class="big" id="resPts">0/0</div>
<div class="pct" id="resPct">0%</div>
</div>
</div>
<div class="card"><h2>üìä Nach Unterthema</h2><div id="topicResults" class="topic-results"></div></div>
<div class="card" id="reviewCard"><h2>üìã Alle Fragen & L√∂sungen</h2><div id="reviewList" class="review-list"></div></div>
<div class="card" style="text-align:center">
<button class="btn btn-primary" onclick="exportResults()" style="margin-right:10px">üìÑ Als PDF speichern</button>
<button class="btn btn-outline" onclick="resetApp()">Neue √úbung starten</button>
</div>
</div>

</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// THEME TOGGLE ‚Äî Light/Dark Mode
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleTheme(){
  var html=document.documentElement;
  var isDark=html.classList.toggle('dark');
  localStorage.setItem('pool-theme',isDark?'dark':'light');
  updateThemeIcon();
}
function updateThemeIcon(){
  var btn=document.getElementById('themeToggle');
  if(btn)btn.textContent=document.documentElement.classList.contains('dark')?'‚òÄÔ∏è':'üåô';
}
// Set correct icon on load
updateThemeIcon();
// Listen for system theme changes (only if no manual override)
window.matchMedia('(prefers-color-scheme:dark)').addEventListener('change',function(e){
  if(localStorage.getItem('pool-theme'))return;
  document.documentElement.classList.toggle('dark',e.matches);
  updateThemeIcon();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KOMPAKTER HEADER ‚Äî Minimierung beim Scrollen
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function(){
  var header=document.querySelector('.app-header');
  if(!header)return;
  var threshold=40;
  var compact=false;
  window.addEventListener('scroll',function(){
    var y=window.scrollY||window.pageYOffset;
    if(y>threshold&&!compact){compact=true;header.classList.add('compact')}
    else if(y<=threshold&&compact){compact=false;header.classList.remove('compact')}
  },{passive:true});
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// POOL LOADER ‚Äî loads data from external JS file
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Color schemes per Fachbereich
const COLOR_SCHEMES = {
  vwl:   { primary: '#f89907', primaryLight: '#ffb74d' },
  bwl:   { primary: '#01a9f4', primaryLight: '#4fc3f7' },
  recht: { primary: '#73ab2c', primaryLight: '#8bc34a' }
};

// Labels (shared across all pools)
const DIFF_LABELS = {1:"‚≠ê Einfach",2:"‚≠ê‚≠ê Mittel",3:"‚≠ê‚≠ê‚≠ê Schwer"};
const TYPE_LABELS = {mc:"üìù Einzelauswahl",multi:"‚òëÔ∏è Mehrfachauswahl",tf:"‚úì‚úó Richtig/Falsch",fill:"üìñ L√ºckentext",calc:"üî¢ Berechnung",sort:"üîÄ Zuordnung",open:"‚úèÔ∏è Offene Frage"};

(async function loadPool() {
  const params = new URLSearchParams(window.location.search);
  const poolId = params.get('pool');
  const poolsParam = params.get('pools'); // comma-separated list for cross-pool mode
  if (!poolId && !poolsParam) { showError('Kein Pool angegeben. Bitte verwenden Sie einen Link mit ?pool=NAME'); return; }
  try {
    if (poolsParam) {
      // ‚îÄ‚îÄ CROSS-POOL MODE: load multiple configs ‚îÄ‚îÄ
      const poolIds = poolsParam.split(',').map(s=>s.trim()).filter(Boolean);
      if (poolIds.length === 0) throw new Error('Keine Pools angegeben.');
      let allQuestions = [];
      let allTopics = {};
      let fach = '';
      let colorKey = '';
      let collectedPoolLZ = [];
      for (const pid of poolIds) {
        window.POOL_META = undefined; window.TOPICS = undefined; window.QUESTIONS = undefined;
        const resp = await fetch('config/' + pid + '.js');
        if (!resp.ok) { console.warn('Pool nicht gefunden: ' + pid); continue; }
        const code = await resp.text();
        const s = document.createElement('script'); s.textContent = code; document.head.appendChild(s);
        if (!window.POOL_META || !window.TOPICS || !window.QUESTIONS) continue;
        if (!fach) { fach = window.POOL_META.fach || ''; colorKey = window.POOL_META.color || fach.toLowerCase(); }
        if (window.POOL_META.lernziele) collectedPoolLZ = collectedPoolLZ.concat(window.POOL_META.lernziele);
        // Add topics with pool prefix to avoid key collisions
        const poolLabel = window.POOL_META.title.replace(/^√úbungspool:\s*/i,'').replace(/^Einf√ºhrung\s*/i,'Einf. ');
        Object.keys(window.TOPICS).forEach(key => {
          const t = window.TOPICS[key];
          const topicCopy = {label: poolLabel+' ‚Üí '+t.label, short: t.short+' ('+poolLabel.substring(0,12)+')'};
          if (t.lernziele) topicCopy.lernziele = t.lernziele;
          allTopics[pid+'::'+key] = topicCopy;
        });
        // Prefix question IDs and topic keys
        window.QUESTIONS.forEach(q => {
          q.topic = pid+'::'+q.topic;
          q.id = pid+'_'+q.id;
          allQuestions.push({...q});
        });
      }
      if (allQuestions.length === 0) throw new Error('Keine Fragen geladen.');
      // Set combined globals
      window.POOL_META = { title: 'Ganzer Fachbereich: ' + fach, fach: fach, color: colorKey, level: '', lernziele: collectedPoolLZ.length ? collectedPoolLZ : undefined };
      window.TOPICS = allTopics;
      window.QUESTIONS = allQuestions;
    } else {
      // ‚îÄ‚îÄ SINGLE POOL MODE ‚îÄ‚îÄ
      const response = await fetch('config/' + poolId + '.js');
      if (!response.ok) throw new Error('Datei nicht gefunden: config/' + poolId + '.js');
      const code = await response.text();
      const scriptEl = document.createElement('script');
      scriptEl.textContent = code;
      document.head.appendChild(scriptEl);
      if (typeof window.POOL_META === 'undefined' || typeof window.TOPICS === 'undefined' || typeof window.QUESTIONS === 'undefined') {
        throw new Error('Pool-Daten unvollst√§ndig');
      }
    }
    // Apply metadata
    var cleanTitle = POOL_META.title.replace(/^√úbungspool[:\s‚Äì‚Äî-]+\s*/i, '');
    document.getElementById('poolTitle').textContent = cleanTitle;
    document.getElementById('poolMeta').textContent = POOL_META.meta || POOL_META.level || '';
    document.title = cleanTitle + ' | Gymnasium Hofwil';
    // Apply color scheme
    const colors = COLOR_SCHEMES[POOL_META.color] || COLOR_SCHEMES[(POOL_META.fach||'').toLowerCase()] || COLOR_SCHEMES.vwl;
    document.documentElement.style.setProperty('--c-primary', colors.primary);
    document.documentElement.style.setProperty('--c-primary-light', colors.primaryLight);
    document.documentElement.style.setProperty('--c-pool', colors.primary);
    // Lernziele: Header-Button anzeigen, falls Lernziele vorhanden
    var hasAnyLZ = (POOL_META.lernziele && POOL_META.lernziele.length) ||
                   Object.values(TOPICS).some(function(t) { return t.lernziele && t.lernziele.length; });
    if (hasAnyLZ) {
      document.getElementById('headerLzBtn').style.display = '';
    }
    // Show the start screen
    document.getElementById('loadingScreen').classList.remove('active');
    document.getElementById('startScreen').classList.add('active');
    init();
    trackInit();
  } catch (err) { showError(err.message); }
})();

function showError(msg) {
  document.getElementById('loadingScreen').classList.remove('active');
  document.getElementById('errorMsg').textContent = msg;
  document.getElementById('errorScreen').classList.add('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let state={mode:null,filters:{topics:new Set(),diffs:new Set(),types:new Set()},queue:[],current:0,score:0,maxScore:0,answered:[],wrong:[]};
let pickedSortItem=null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LEARNINGVIEW INTEGRATION
// Sends xAPI score via postMessage when embedded as iframe.
// LearningView uses result.score.scaled (0‚Äì1) as primary value.
// Sends progressively after each answer AND on quiz end.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function sendScoreToLV(){
  if(window.parent===window)return;
  if(state.queue.length===0)return;
  var total=state.queue.length;
  var scaled=state.score/total;
  var xAPIscore={
    result:{
      score:{
        scaled: Math.round(scaled*1000)/1000,
        max:    total,
        raw:    state.score
      }
    }
  };
  try{ window.parent.postMessage(xAPIscore,'*'); }catch(e){}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SKIP QUESTION
// Skipped questions don't count toward score.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function skipQuestion(){
  const q=state.queue[state.current];
  state.answered[state.current]={id:q.id,skipped:true};
  trackSkip(q);
  state.current++;
  if(state.current>=state.queue.length)return endQuiz();
  renderQuestion();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PREVIOUS QUESTION ‚Äî navigate back
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function prevQuestion(){
  if(state.current<=0)return;
  state.current--;
  renderQuestion();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILL HINTS ‚Äî show word bank for fill questions
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showHints(qid){
  const hintsDiv=document.getElementById('hintsContainer');
  if(!hintsDiv)return;
  if(hintsDiv.style.display!=='none'){hintsDiv.style.display='none';return;}
  const q=QUESTIONS.find(x=>x.id===qid);
  if(!q||!q.hints)return;

  let html='';

  if(q.type==='fill'){
    // Collect correct answers
    const correctWords=q.blanks.map(b=>b.answer);
    // q.hints are distractors for fill type
    let distractors=[];
    if(q.hints&&q.hints.length){
      distractors=q.hints.filter(h=>!correctWords.some(c=>c.toLowerCase()===h.toLowerCase()));
    } else {
      // Auto-generate distractors from other fill questions in this pool
      let pool=[];
      QUESTIONS.forEach(oq=>{
        if(oq.type==='fill'&&oq.id!==qid){
          oq.blanks.forEach(b=>{
            if(!correctWords.some(c=>c.toLowerCase()===b.answer.toLowerCase()))pool.push(b.answer);
            if(b.alts)b.alts.forEach(a=>{if(!correctWords.some(c=>c.toLowerCase()===a.toLowerCase()))pool.push(a)});
          });
        }
      });
      pool=[...new Set(pool)];shuffle(pool);
      distractors=pool.slice(0,Math.min(Math.max(correctWords.length+1,3),pool.length,5));
    }
    const allWords=[...correctWords,...distractors];shuffle(allWords);
    html='<div class="fill-hint-label">M√∂gliche Begriffe (nicht alle sind korrekt):</div>';
    allWords.forEach(w=>{html+='<span class="fill-hint-word">'+w+'</span>'});
    hintsDiv.className='hints-container fill-hints';
  } else {
    // For mc, multi, open, calc: display text hints as a list
    html='<div class="text-hints-label">üí° Tipps:</div>';
    q.hints.forEach(hint=>{
      html+='<div class="text-hint-item">‚Ä¢ '+hint+'</div>';
    });
    hintsDiv.className='hints-container text-hints';
  }

  hintsDiv.innerHTML=html;hintsDiv.style.display='flex';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RESTORE ANSWER STATE ‚Äî for back navigation
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function restoreAnswerState(q,answer){
  if(q.type==='mc'){
    document.querySelectorAll('.mc-opt').forEach(o=>{
      o.style.pointerEvents='none';
      if(o.dataset.val===q.correct)o.classList.add('correct');
    });
  } else if(q.type==='multi'){
    const cs=new Set(q.correct);
    document.querySelectorAll('#multiOpts .mc-opt').forEach(o=>{
      o.style.pointerEvents='none';
      if(cs.has(o.dataset.val)){o.classList.add('correct');o.querySelector('.opt-check').textContent='‚úì'}
      else o.classList.add('multi-neutral');
    });
  } else if(q.type==='tf'){
    document.querySelectorAll('.tf-btn').forEach(b=>{
      b.style.pointerEvents='none';
      const isTrue=b.textContent.includes('Richtig');
      if((isTrue&&q.correct)||(!isTrue&&!q.correct))b.classList.add('correct');
    });
  } else if(q.type==='fill'){
    document.querySelectorAll('.fill-input').forEach(inp=>{
      const bi=parseInt(inp.dataset.bidx);inp.value=q.blanks[bi].answer;
      inp.classList.add('correct');inp.disabled=true;
    });
  } else if(q.type==='calc'){
    document.querySelectorAll('.calc-row input').forEach(inp=>{
      const ri=parseInt(inp.dataset.ridx);inp.value=q.rows[ri].answer;
      inp.classList.add('correct');inp.disabled=true;
    });
  } else if(q.type==='sort'){
    document.querySelectorAll('.sort-item,.sort-cat').forEach(el=>el.style.pointerEvents='none');
  } else if(q.type==='open'){
    var ta=document.getElementById('openAnswer');if(ta)ta.disabled=true;
    var sample=document.getElementById('openSample');if(sample){document.getElementById('openSampleText').textContent=q.sample||'';sample.classList.add('show')}
  }
  const fb=document.getElementById('feedback');
  fb.className='feedback show '+(answer.correct?'correct':'wrong');
  fb.innerHTML='<div class="feedback-title">'+(answer.correct?'‚úÖ Richtig!':'‚ùå Leider falsch')+'</div><div>'+q.explain+'</div>';
  document.getElementById('nextBtn').style.display='inline-flex';
  var skip=document.querySelector('.btn-skip');if(skip)skip.style.display='none';
  var hints=document.getElementById('hintsBtn');if(hints)hints.style.display='none';
  document.querySelectorAll('#skipRow .btn-primary:not(#nextBtn)').forEach(b=>b.style.display='none');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KEYBOARD NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('keydown',function(e){
  if(!document.getElementById('quizScreen').classList.contains('active'))return;
  if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA')return;
  const q=state.queue[state.current];if(!q)return;
  if(e.key==='ArrowRight'){
    e.preventDefault();
    var nextBtn=document.getElementById('nextBtn');
    if(nextBtn&&nextBtn.style.display!=='none')nextQuestion();
    else skipQuestion();
  } else if(e.key==='ArrowLeft'){
    e.preventDefault();prevQuestion();
  } else if(e.key==='Enter'){
    e.preventDefault();
    var checkBtn=document.querySelector('#skipRow .btn-primary');
    if(checkBtn&&checkBtn.style.display!=='none')checkBtn.click();
  } else if(q.type==='mc'&&['1','2','3','4'].includes(e.key)){
    var idx=parseInt(e.key)-1;
    var opts=document.querySelectorAll('.mc-opt');
    if(opts[idx])opts[idx].click();
  } else if(q.type==='tf'&&(e.key==='1'||e.key==='2')){
    var btns=document.querySelectorAll('.tf-btn');
    if(e.key==='1'&&btns[0])btns[0].click();
    if(e.key==='2'&&btns[1])btns[1].click();
  } else if(q.type==='multi'&&['1','2','3','4'].includes(e.key)){
    var idx2=parseInt(e.key)-1;
    var mopts=document.querySelectorAll('#multiOpts .mc-opt');
    if(mopts[idx2])mopts[idx2].click();
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ANALYTICS TRACKING ‚Äî Anonymes Nutzungstracking via Google Apps Script
// Sendet Events (answer, skip, session_end) an ein Google Sheet.
// Tracking ist nur aktiv wenn eine Klasse ausgew√§hlt wurde.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const TRACKING_CONFIG={
  // ‚ïê‚ïê DEINE APPS-SCRIPT-URL HIER EINTRAGEN: ‚ïê‚ïê
  endpoint:'',
  klassen:['27a','27abcd8f','28a','28abcdf','29c','andere']
};
var _trackSid='';
var _trackKlasse='';
var _trackStart=0;
var _trackQStart=0;

function trackInit(){
  // Session-ID generieren
  _trackSid='s_'+Date.now()+'_'+Math.random().toString(36).substr(2,4);
  // Klasse aus URL oder Dropdown
  const p=new URLSearchParams(window.location.search);
  if(p.get('klasse'))_trackKlasse=p.get('klasse');
  // Klassen-Dropdown im Startscreen einf√ºgen
  const fc=document.getElementById('filterCount');
  if(fc&&!document.getElementById('klasseSelect')){
    var html='<div class="klasse-row" style="margin-top:10px;display:flex;align-items:center;gap:8px;flex-wrap:wrap">';
    html+='<label for="klasseSelect" style="font-size:.82rem;font-weight:600;color:var(--c-muted)">üë• Klasse (optional):</label>';
    html+='<select id="klasseSelect" style="padding:4px 10px;border-radius:8px;border:1px solid var(--c-border);background:var(--c-surface);color:var(--c-text);font-size:.82rem;font-family:inherit">';
    html+='<option value="">‚Äì keine Angabe ‚Äì</option>';
    TRACKING_CONFIG.klassen.forEach(function(k){html+='<option value="'+k+'"'+(k===_trackKlasse?' selected':'')+'>'+k+'</option>'});
    html+='</select></div>';
    fc.insertAdjacentHTML('afterend',html);
  }
}

function trackEvent(evt,data){
  if(!TRACKING_CONFIG.endpoint)return;
  // Klasse aus Dropdown lesen falls nicht via URL gesetzt
  var sel=document.getElementById('klasseSelect');
  if(sel)_trackKlasse=sel.value;
  if(!_trackKlasse)return; // Kein Tracking ohne Klasse
  var poolId=new URLSearchParams(window.location.search).get('pool')||'';
  var params=new URLSearchParams();
  params.set('event',evt);
  params.set('sid',_trackSid);
  params.set('pool',poolId);
  params.set('klasse',_trackKlasse);
  if(data){Object.keys(data).forEach(function(k){params.set(k,data[k])})}
  // Image-Ping (gleich wie Problemmeldung ‚Äî zuverl√§ssigste Cross-Origin Methode)
  var img=new Image();
  img.src=TRACKING_CONFIG.endpoint+'?'+params.toString();
}

function trackAnswer(q,correct,userAnswer){
  var zeit=_trackQStart?Date.now()-_trackQStart:0;
  trackEvent('answer',{
    qid:q.id, topic:q.topic, qtype:q.type, diff:q.diff,
    correct:correct?'1':'0', answer:userAnswer||'', zeit:zeit
  });
}

function trackSkip(q){
  trackEvent('skip',{qid:q.id, topic:q.topic, qtype:q.type, diff:q.diff});
}

function trackSessionEnd(){
  var dauer=_trackStart?Math.round((Date.now()-_trackStart)/1000):0;
  var topicsUsed=[...new Set(state.queue.map(function(q){return q.topic}))].join(',');
  trackEvent('session_end',{
    score:state.score, max:state.maxScore,
    dauer:dauer, count:state.queue.length, topics:topicsUsed
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REPORT PROBLEM ‚Äî In-App Modal + Google Apps Script
// Shows a modal inside the pool, sends data to Apps Script ‚Üí Google Sheet.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const REPORT_CONFIG={
  // ‚ïê‚ïê DEINE APPS-SCRIPT-URL HIER EINTRAGEN: ‚ïê‚ïê
  endpoint:'https://script.google.com/macros/s/AKfycbw46sH_lj9uH9f1C6olplv2PMhTUHU9i1LELin2GDO4a2N8S5adX4CzUyATO0jQW4Yuvw/exec',
  categories:['Fachlicher Fehler','Technisches Problem','Unklar formuliert','Anderes']
};
var _reportQid=null;

function showReport(qid){
  const q=QUESTIONS.find(x=>x.id===qid);
  if(!q)return;
  _reportQid=qid;
  var poolId=new URLSearchParams(window.location.search).get('pool')||'';
  var topicLabel=TOPICS[q.topic]?(TOPICS[q.topic].short||TOPICS[q.topic].label):q.topic;
  var qText=q.q.replace(/<[^>]*>/g,'').substring(0,120);
  // Build meta info
  document.getElementById('reportMeta').innerHTML=
    '<strong>Pool:</strong> '+POOL_META.title+' ('+poolId+')<br>'+
    '<strong>Frage:</strong> '+q.id+' ‚Äî '+topicLabel+'<br>'+
    '<strong>Text:</strong> '+qText+(q.q.replace(/<[^>]*>/g,'').length>120?'‚Ä¶':'');
  // Reset state
  document.querySelectorAll('.report-cat').forEach(function(c){c.classList.remove('active')});
  document.getElementById('reportComment').value='';
  document.getElementById('reportError').style.display='none';
  document.getElementById('reportForm').style.display='block';
  document.getElementById('reportDone').style.display='none';
  document.getElementById('reportSendBtn').disabled=false;
  document.getElementById('reportSendBtn').textContent='üì® Senden';
  // Show overlay
  document.getElementById('reportOverlay').classList.add('active');
}

function closeReport(){
  document.getElementById('reportOverlay').classList.remove('active');
  _reportQid=null;
}

function selectReportCat(el){
  document.querySelectorAll('.report-cat').forEach(function(c){c.classList.remove('active')});
  el.classList.add('active');
}

function sendReport(){
  var cat=document.querySelector('.report-cat.active');
  if(!cat){
    document.getElementById('reportError').textContent='Bitte w√§hle eine Kategorie.';
    document.getElementById('reportError').style.display='block';
    return;
  }
  var q=QUESTIONS.find(function(x){return x.id===_reportQid});
  if(!q){closeReport();return}
  var poolId=new URLSearchParams(window.location.search).get('pool')||'';
  var topicLabel=TOPICS[q.topic]?(TOPICS[q.topic].short||TOPICS[q.topic].label):q.topic;

  var params=new URLSearchParams({
    pool:POOL_META.title+' ('+poolId+')',
    qid:q.id,
    topic:topicLabel,
    text:q.q.replace(/<[^>]*>/g,'').substring(0,200),
    category:cat.textContent.trim(),
    comment:document.getElementById('reportComment').value.trim()
  });

  var btn=document.getElementById('reportSendBtn');
  btn.disabled=true;
  btn.textContent='Wird gesendet‚Ä¶';
  document.getElementById('reportError').style.display='none';

  // GET-Request via Image-Ping ‚Äî zuverl√§ssigste Cross-Origin Methode
  var img=new Image();
  img.onload=img.onerror=function(){
    document.getElementById('reportForm').style.display='none';
    document.getElementById('reportDone').style.display='block';
    setTimeout(closeReport,1800);
  };
  img.src=REPORT_CONFIG.endpoint+'?'+params.toString();

  // Fallback falls weder onload noch onerror feuert
  setTimeout(function(){
    if(document.getElementById('reportDone').style.display==='none'){
      document.getElementById('reportForm').style.display='none';
      document.getElementById('reportDone').style.display='block';
      setTimeout(closeReport,1800);
    }
  },5000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function init(){
  buildChips('topicChips',TOPICS,'topics',t=>TOPICS[t].short);
  buildChips('diffChips',DIFF_LABELS,'diffs',d=>DIFF_LABELS[d]);
  buildChips('typeChips',TYPE_LABELS,'types',t=>TYPE_LABELS[t]);
  setMode('mix');
  patchGetFiltered();
  initSearch();
  updateFilterCount();
  applyDeepLink();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DEEP LINK ‚Äî Direktzugriff auf Unterthemen via URL-Parameter
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function applyDeepLink(){
  const params=new URLSearchParams(window.location.search);
  if(params.get('keys')==='1'){ showInfoScreen(); return; }
  // lz= Parameter: Topic √ºber Lernziel-Kontext starten
  const lzParam=params.get('lz');
  if(lzParam && TOPICS[lzParam]){
    startFromLZ(lzParam);
    return;
  }
  const topicParam=params.get('topic');
  if(!topicParam)return;
  const topicKeys=topicParam.split(',').filter(k=>TOPICS[k]);
  if(topicKeys.length===0)return;
  // Deep-Link: nur relevante Topics aktiv, alle Diffs/Types aktiv
  state.filters.topics.clear();
  document.querySelectorAll('#topicChips .chip').forEach(ch=>ch.classList.remove('active'));
  topicKeys.forEach(k=>{
    state.filters.topics.add(k);
    const chip=document.querySelector('#topicChips .chip[data-key="'+k+'"]');
    if(chip)chip.classList.add('active');
  });
  const diffParam=params.get('diff');
  if(diffParam){
    state.filters.diffs.clear();
    document.querySelectorAll('#diffChips .chip').forEach(ch=>ch.classList.remove('active'));
    diffParam.split(',').filter(d=>DIFF_LABELS[d]).forEach(d=>{
      state.filters.diffs.add(d);
      const chip=document.querySelector('#diffChips .chip[data-key="'+d+'"]');
      if(chip)chip.classList.add('active');
    });
  }
  const typeParam=params.get('type');
  if(typeParam){
    state.filters.types.clear();
    document.querySelectorAll('#typeChips .chip').forEach(ch=>ch.classList.remove('active'));
    typeParam.split(',').filter(t=>TYPE_LABELS[t]).forEach(t=>{
      state.filters.types.add(t);
      const chip=document.querySelector('#typeChips .chip[data-key="'+t+'"]');
      if(chip)chip.classList.add('active');
    });
  }
  updateFilterCount();
  if(params.get('start')==='1'&&getFiltered().length>0){ startQuiz(); }
}

function showInfoScreen(){
  const poolId=new URLSearchParams(window.location.search).get('pool')||'';
  const baseUrl=window.location.origin+window.location.pathname+'?pool='+poolId;
  let html='';
  const counts={};
  QUESTIONS.forEach(q=>{counts[q.topic]=(counts[q.topic]||0)+1});
  Object.keys(TOPICS).forEach(key=>{
    const t=TOPICS[key]; const count=counts[key]||0;
    const link=baseUrl+'&topic='+encodeURIComponent(key);
    html+='<div class="info-row">';
    html+='<div class="info-topic"><div class="info-topic-label">'+t.label+'</div>';
    html+='<div class="info-topic-key">Key: <strong>'+key+'</strong></div>';
    html+='<div class="info-topic-count">'+count+' Aufgabe'+(count!==1?'n':'')+'</div></div>';
    html+='<div class="info-link-box">';
    html+='<input class="info-link-input" value="'+link+'" readonly onclick="this.select()">';
    html+='<button class="info-copy-btn" title="Link kopieren" onclick="copyInfoLink(this,\''+link.replace(/'/g,"\\'")+'\')">üìã</button>';
    html+='</div></div>';
  });
  document.getElementById('infoLinks').innerHTML=html;
  document.getElementById('startScreen').classList.remove('active');
  document.getElementById('infoScreen').classList.add('active');
}

function copyInfoLink(btn,link){
  navigator.clipboard.writeText(link).then(()=>{
    btn.textContent='‚úÖ';btn.classList.add('copied');
    setTimeout(()=>{btn.textContent='üìã';btn.classList.remove('copied')},1500);
  }).catch(()=>{ btn.parentElement.querySelector('.info-link-input').select(); });
}

function buildChips(containerId,obj,filterKey,labelFn){
  const c=document.getElementById(containerId); c.innerHTML='';
  Object.keys(obj).forEach(k=>{
    const ch=document.createElement('span'); ch.className='chip';
    ch.dataset.key=k; ch.onclick=function(e){if(!e.target.classList.contains('chip-lz'))toggleChip(ch,filterKey,k);};
    var label=labelFn(k);
    // Lernziele-Button f√ºr Topic-Chips
    var hasLZ=containerId==='topicChips'&&obj[k].lernziele&&obj[k].lernziele.length;
    if(hasLZ){
      ch.innerHTML=label+' <span class="chip-lz" onclick="event.stopPropagation();openMini(\''+k+'\')" title="Lernziele anzeigen">üèÅ</span>';
    } else {
      ch.textContent=label;
    }
    c.appendChild(ch);
  });
}

function setMode(m){
  state.mode=m;
  if(m==='mix'){
    ['topicChips','diffChips','typeChips'].forEach(id=>{
      document.querySelectorAll('#'+id+' .chip').forEach(ch=>{
        ch.classList.add('active');
        state.filters[id==='topicChips'?'topics':id==='diffChips'?'diffs':'types'].add(ch.dataset.key);
      });
    });
  } else {
    ['topicChips','diffChips'].forEach(id=>{
      document.querySelectorAll('#'+id+' .chip').forEach(ch=>ch.classList.remove('active'));
      state.filters[id==='topicChips'?'topics':'diffs'].clear();
    });
    document.querySelectorAll('#typeChips .chip').forEach(ch=>{
      ch.classList.add('active'); state.filters.types.add(ch.dataset.key);
    });
  }
  updateFilterCount();
}

function toggleChip(el,filterKey,key){
  el.classList.toggle('active');
  if(el.classList.contains('active'))state.filters[filterKey].add(key);
  else state.filters[filterKey].delete(key);
  updateFilterCount();
}

function toggleAll(containerId,filterKey){
  const chips=document.querySelectorAll('#'+containerId+' .chip');
  const allActive=[...chips].every(c=>c.classList.contains('active'));
  chips.forEach(ch=>{
    if(allActive){
      ch.classList.remove('active');
      state.filters[filterKey].delete(ch.dataset.key);
    } else {
      ch.classList.add('active');
      state.filters[filterKey].add(ch.dataset.key);
    }
  });
  updateFilterCount();
}

function getFiltered(){
  return QUESTIONS.filter(q=>
    (state.filters.topics.size===0||state.filters.topics.has(q.topic))&&
    (state.filters.diffs.size===0||state.filters.diffs.has(String(q.diff)))&&
    (state.filters.types.size===0||state.filters.types.has(q.type))
  );
}

function updateFilterCount(){
  const n=getFiltered().length;
  document.getElementById('filterCount').textContent=n+' Aufgabe'+(n!==1?'n':'')+' verf√ºgbar';
  document.getElementById('startBtn').disabled=n===0||!state.mode;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// QUIZ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startQuiz(){
  let q=getFiltered();
  shuffle(q);
  state.queue=q;state.current=0;state.score=0;state.maxScore=0;state.answered=[];state.wrong=[];
  _trackStart=Date.now();
  showScreen('quizScreen'); renderQuestion();
}

function renderQuestion(){
  _trackQStart=Date.now();
  const q=state.queue[state.current]; const total=state.queue.length;
  const pctProgress=Math.round(state.current/total*100);
  let html='<div class="q-progress-bg"></div><div class="q-progress-bar" style="width:'+pctProgress+'%"></div>';
  html+='<div class="q-badges">';
  html+='<span class="badge badge-topic">'+TOPICS[q.topic].short+'</span>';
  html+='<span class="badge badge-diff'+q.diff+'">'+DIFF_LABELS[q.diff]+'</span>';
  html+='<span class="badge badge-tax">'+q.tax+'</span>';
  html+='<span class="badge badge-type">'+TYPE_LABELS[q.type]+'</span>';
  html+='<span class="badge badge-progress">'+(state.current+1)+' / '+total+'</span>';
  html+='<span class="badge badge-score">'+state.score+' Pkt.</span>';
  html+='</div>';
  html+=renderContext(q);
  html+='<div class="q-text">'+q.q+'</div>';
  html+=renderImg(q);
  if(q.type==='mc'){
    html+='<div class="mc-options">';
    q.options.forEach(o=>{
      html+='<div class="mc-opt" data-val="'+o.v+'" onclick="answerMC(this,\''+q.id+'\',\''+o.v+'\')">';
      html+='<span class="opt-letter">'+o.v+'</span><span class="opt-text">'+o.t+'</span></div>';
    });
    html+='</div>';
  } else if(q.type==='multi'){
    html+='<div class="multi-hint">‚òëÔ∏è Mehrere Antworten k√∂nnen richtig sein.</div>';
    html+='<div class="mc-options" id="multiOpts">';
    q.options.forEach(o=>{
      html+='<div class="mc-opt" data-val="'+o.v+'" onclick="toggleMulti(this)">';
      html+='<span class="opt-check"></span><span class="opt-letter">'+o.v+'</span><span class="opt-text">'+o.t+'</span></div>';
    });
    html+='</div>';
  } else if(q.type==='tf'){
    html+='<div class="tf-btns"><div class="tf-btn" onclick="answerTF(this,\''+q.id+'\',true)">‚úÖ Richtig</div>';
    html+='<div class="tf-btn" onclick="answerTF(this,\''+q.id+'\',false)">‚ùå Falsch</div></div>';
  } else if(q.type==='fill'){
    let parts=q.q.split(/\{(\d+)\}/g);
    html='<div class="q-progress-bg"></div><div class="q-progress-bar" style="width:'+pctProgress+'%"></div>';
    html+='<div class="q-badges">';
    html+='<span class="badge badge-topic">'+TOPICS[q.topic].short+'</span>';
    html+='<span class="badge badge-diff'+q.diff+'">'+DIFF_LABELS[q.diff]+'</span>';
    html+='<span class="badge badge-tax">'+q.tax+'</span>';
    html+='<span class="badge badge-type">'+TYPE_LABELS[q.type]+'</span>';
    html+='<span class="badge badge-progress">'+(state.current+1)+' / '+total+'</span>';
    html+='<span class="badge badge-score">'+state.score+' Pkt.</span>';
    html+='</div>';
    html+=renderContext(q);
    html+='<div class="q-text">';
    let bIdx=0;
    for(let i=0;i<parts.length;i++){
      if(i%2===0)html+=parts[i];
      else html+='<input class="fill-input" data-bidx="'+bIdx+'" placeholder="‚Ä¶" autocomplete="off" autocapitalize="off">';
      if(i%2===1)bIdx++;
    }
    html+='</div>';
    html+=renderImg(q);
  } else if(q.type==='calc'){
    html+='<div class="calc-rows">';
    q.rows.forEach((r,i)=>{
      html+='<div class="calc-row"><label>'+r.label+'</label><input type="number" step="any" data-ridx="'+i+'" placeholder="?"><span class="unit">'+r.unit+'</span></div>';
    });
    html+='</div>';
  } else if(q.type==='sort'){
    html+='<div class="sort-pool" id="sortPool">';
    let items=[...q.items];shuffle(items);
    items.forEach((it,i)=>{
      html+='<span class="sort-item" data-oidx="'+q.items.indexOf(it)+'" onclick="pickSortItem(this)">'+it.t+'</span>';
    });
    html+='</div><div class="sort-cats" id="sortCats" style="grid-template-columns:repeat('+q.categories.length+',1fr)">';
    q.categories.forEach((cat,ci)=>{
      html+='<div class="sort-cat" data-cidx="'+ci+'" onclick="placeSortItem(this,'+ci+')"><div class="sort-cat-title">'+cat+'</div><div class="sort-cat-items" id="sortCat'+ci+'"></div></div>';
    });
    html+='</div>';
  } else if(q.type==='open'){
    html+='<textarea class="open-answer" id="openAnswer" placeholder="Schreiben Sie Ihre Antwort hier‚Ä¶"></textarea>';
    html+='<div class="open-sample" id="openSample"><div class="open-sample-title">L√∂sungsvorschlag:</div><div id="openSampleText"></div></div>';
    html+='<div class="open-self" id="openSelf">';
    html+='<button class="btn btn-primary" onclick="answerOpen(\''+q.id+'\',true)">‚úÖ Gewusst</button>';
    html+='<button class="btn btn-outline" onclick="answerOpen(\''+q.id+'\',false)">‚ùå Nicht gewusst</button>';
    html+='</div>';
  }
  // Unified action row: type-specific button + skip (same line)
  html+='<div class="feedback" id="feedback"></div>';
  // Hints container for all types that support hints
  if((q.type==='fill')||(q.type==='mc'&&q.hints&&q.hints.length)||(q.type==='multi'&&q.hints&&q.hints.length)||(q.type==='open'&&q.hints&&q.hints.length)||(q.type==='calc'&&q.hints&&q.hints.length)){
    html+='<div class="hints-container" id="hintsContainer" style="display:none"></div>';
  }
  html+='<div class="q-action-row" id="skipRow">';
  if(state.current>0)html+='<button class="btn btn-back" onclick="prevQuestion()">‚Üê Zur√ºck</button>';
  if(q.type==='fill'){
    html+='<button class="btn btn-outline" id="hintsBtn" onclick="showHints(\''+q.id+'\')">üí° Tipps</button>';
    html+='<button class="btn btn-primary" onclick="answerFill(\''+q.id+'\')">üîç √úberpr√ºfen</button>';
  }
  else if(q.type==='mc'){
    if(q.hints&&q.hints.length)html+='<button class="btn btn-outline" id="hintsBtn" onclick="showHints(\''+q.id+'\')">üí° Tipps</button>';
  }
  else if(q.type==='multi'){
    if(q.hints&&q.hints.length)html+='<button class="btn btn-outline" id="hintsBtn" onclick="showHints(\''+q.id+'\')">üí° Tipps</button>';
    html+='<button class="btn btn-primary" onclick="answerMulti(\''+q.id+'\')">üîç √úberpr√ºfen</button>';
  }
  else if(q.type==='calc'){
    if(q.hints&&q.hints.length)html+='<button class="btn btn-outline" id="hintsBtn" onclick="showHints(\''+q.id+'\')">üí° Tipps</button>';
    html+='<button class="btn btn-primary" onclick="answerCalc(\''+q.id+'\')">üîç √úberpr√ºfen</button>';
  }
  else if(q.type==='sort') html+='<button class="btn btn-primary" onclick="answerSort(\''+q.id+'\')">üîç √úberpr√ºfen</button>';
  else if(q.type==='open'){
    if(q.hints&&q.hints.length)html+='<button class="btn btn-outline" id="hintsBtn" onclick="showHints(\''+q.id+'\')">üí° Tipps</button>';
    html+='<button class="btn btn-primary" onclick="showOpenSample(\''+q.id+'\')">üí° L√∂sung anzeigen</button>';
  }
  html+='<button class="btn btn-skip" onclick="skipQuestion()">‚è≠Ô∏è √úberspringen</button>';
  html+='<button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()" style="display:none;margin-left:auto">N√§chste Aufgabe ‚Üí</button>';
  html+='</div>';
  html+='<div class="q-bottom-row" id="qBottomRow"><button class="btn-end" onclick="endQuiz()">üèÅ √úbung beenden</button><button class="btn-report" onclick="showReport(\''+q.id+'\')">‚ö†Ô∏è Problem melden</button></div>';
  html+='<div class="kbd-hint">Tastatur: <kbd>‚Üê</kbd> Zur√ºck ¬∑ <kbd>‚Üí</kbd> Weiter/√úberspringen ¬∑ <kbd>1</kbd>‚Äì<kbd>4</kbd> Antwort ¬∑ <kbd>Enter</kbd> Pr√ºfen</div>';
  document.getElementById('questionCard').innerHTML=html;
  pickedSortItem=null;
  // Restore state if navigating back to an already-answered question
  var prevAns=state.answered[state.current];
  if(prevAns&&!prevAns.skipped){restoreAnswerState(q,prevAns)}
  if(prevAns&&prevAns.skipped){state.answered[state.current]=undefined}
}

// ‚îÄ‚îÄ Answer handlers ‚îÄ‚îÄ
function answerMC(el,qid,val){
  if(document.querySelector('.mc-opt.correct,.mc-opt.wrong'))return;
  const q=QUESTIONS.find(x=>x.id===qid);
  document.querySelectorAll('.mc-opt').forEach(o=>{
    o.style.pointerEvents='none';
    if(o.dataset.val===q.correct)o.classList.add('correct');
    else if(o.dataset.val===val)o.classList.add('wrong');
  });
  finishAnswer(q,val===q.correct,q.explain,val);
}

function toggleMulti(el){
  if(el.classList.contains('correct')||el.classList.contains('wrong'))return;
  el.classList.toggle('selected');
  el.querySelector('.opt-check').textContent=el.classList.contains('selected')?'‚úì':'';
}

function answerMulti(qid){
  if(document.querySelector('#multiOpts .mc-opt.correct,#multiOpts .mc-opt.wrong'))return;
  const q=QUESTIONS.find(x=>x.id===qid);
  const correctSet=new Set(q.correct);
  const selected=new Set();
  document.querySelectorAll('#multiOpts .mc-opt.selected').forEach(o=>selected.add(o.dataset.val));
  let allCorrect=correctSet.size===selected.size&&[...correctSet].every(v=>selected.has(v));
  document.querySelectorAll('#multiOpts .mc-opt').forEach(o=>{
    o.style.pointerEvents='none';
    const val=o.dataset.val;
    const isCorrect=correctSet.has(val);
    const isSelected=selected.has(val);
    if(isCorrect)o.classList.add('correct');
    else if(isSelected)o.classList.add('wrong');
    else o.classList.add('multi-neutral');
    o.querySelector('.opt-check').textContent=isCorrect?'‚úì':'';
  });
  document.querySelectorAll('#skipRow .btn-primary:not(#nextBtn)').forEach(b=>b.style.display='none');
  finishAnswer(q,allCorrect,q.explain,[...selected].join(','));
}

function answerTF(el,qid,val){
  if(document.querySelector('.tf-btn.correct,.tf-btn.wrong'))return;
  const q=QUESTIONS.find(x=>x.id===qid);
  const correct=val===q.correct;
  document.querySelectorAll('.tf-btn').forEach(b=>b.style.pointerEvents='none');
  el.classList.add(correct?'correct':'wrong');
  if(!correct)document.querySelectorAll('.tf-btn').forEach(b=>{if(b!==el)b.classList.add('correct')});
  finishAnswer(q,correct,q.explain,String(val));
}

function answerFill(qid){
  const q=QUESTIONS.find(x=>x.id===qid);
  const inputs=document.querySelectorAll('.fill-input');
  let allCorrect=true;
  inputs.forEach(inp=>{
    const bi=parseInt(inp.dataset.bidx); const blank=q.blanks[bi];
    const userVal=inp.value.trim().toLowerCase();
    const ok=userVal===blank.answer.toLowerCase()||blank.alts.some(a=>userVal===a.toLowerCase());
    inp.classList.add(ok?'correct':'wrong'); inp.disabled=true;
    if(!ok){allCorrect=false;inp.value=inp.value+' ‚Üí '+blank.answer}
  });
  finishAnswer(q,allCorrect,q.explain);
}

function answerCalc(qid){
  const q=QUESTIONS.find(x=>x.id===qid);
  const inputs=document.querySelectorAll('.calc-row input');
  let allCorrect=true;
  inputs.forEach(inp=>{
    const ri=parseInt(inp.dataset.ridx); const row=q.rows[ri];
    const val=parseFloat(inp.value);
    const ok=!isNaN(val)&&Math.abs(val-row.answer)<=row.tolerance;
    inp.classList.add(ok?'correct':'wrong'); inp.disabled=true;
    if(!ok){allCorrect=false;inp.value=inp.value+' ‚Üí '+row.answer}
  });
  finishAnswer(q,allCorrect,q.explain);
}

function pickSortItem(el){
  if(el.classList.contains('placed'))return;
  document.querySelectorAll('.sort-item').forEach(s=>s.classList.remove('picked'));
  el.classList.add('picked'); pickedSortItem=el;
  // Highlight categories as drop targets
  document.querySelectorAll('.sort-cat').forEach(c=>c.classList.add('awaiting'));
}

function placeSortItem(catEl,cidx){
  if(!pickedSortItem)return;
  const container=catEl.querySelector('.sort-cat-items');
  const clone=document.createElement('span');
  clone.className='sort-cat-item'; clone.textContent=pickedSortItem.textContent;
  clone.dataset.oidx=pickedSortItem.dataset.oidx;
  clone.onclick=function(){this.remove();
    const orig=document.querySelector('.sort-item[data-oidx="'+this.dataset.oidx+'"]');
    if(orig){orig.style.display='';orig.classList.remove('placed')}
  };
  container.appendChild(clone);
  pickedSortItem.style.display='none';
  pickedSortItem.classList.add('placed');
  pickedSortItem.classList.remove('picked');
  pickedSortItem=null;
  // Remove drop target highlight
  document.querySelectorAll('.sort-cat').forEach(c=>c.classList.remove('awaiting'));
}

function answerSort(qid){
  const q=QUESTIONS.find(x=>x.id===qid);
  let allCorrect=true;
  document.querySelectorAll('.sort-cat').forEach(catEl=>{
    const cidx=parseInt(catEl.dataset.cidx);
    catEl.querySelectorAll('.sort-cat-item').forEach(item=>{
      const oidx=parseInt(item.dataset.oidx);
      const ok=q.items[oidx].cat===cidx;
      item.classList.add(ok?'correct-item':'wrong-item');
      if(!ok)allCorrect=false;
    });
  });
  document.querySelectorAll('.sort-item').forEach(s=>s.style.pointerEvents='none');
  document.querySelectorAll('.sort-cat').forEach(c=>c.style.pointerEvents='none');
  document.querySelectorAll('#questionCard .btn-primary:not(#nextBtn)').forEach(b=>b.style.display='none');
  finishAnswer(q,allCorrect,q.explain);
}

function showOpenSample(qid){
  const q=QUESTIONS.find(x=>x.id===qid);
  document.getElementById('openSampleText').textContent=q.sample;
  document.getElementById('openSample').classList.add('show');
  document.getElementById('openSelf').classList.add('show');
  document.querySelectorAll('#questionCard .btn-primary:not(#nextBtn)').forEach(b=>{if(b.textContent.includes('L√∂sung'))b.style.display='none'});
  document.querySelector('.btn-skip').style.display='none';
}

function answerOpen(qid,correct){
  const q=QUESTIONS.find(x=>x.id===qid);
  document.getElementById('openSelf').style.display='none';
  document.getElementById('openAnswer').disabled=true;
  finishAnswer(q,correct,q.explain);
}

function finishAnswer(q,correct,explain,userAnswer){
  // Check if re-answering a previously skipped question
  const wasSkipped=state.answered[state.current]&&state.answered[state.current].skipped;
  state.maxScore++;
  if(correct)state.score++; else state.wrong.push({q:q.q,explain:q.explain,topic:q.topic});
  state.answered[state.current]={id:q.id,correct};
  trackAnswer(q,correct,userAnswer||'');
  sendScoreToLV();
  const fb=document.getElementById('feedback');
  fb.className='feedback show '+(correct?'correct':'wrong');
  fb.innerHTML='<div class="feedback-title">'+(correct?'‚úÖ Richtig!':'‚ùå Leider falsch')+'</div><div>'+explain+'</div>';
  document.getElementById('nextBtn').style.display='inline-flex';
  document.getElementById('nextBtn').style.marginLeft='auto';
  var skip=document.querySelector('.btn-skip');if(skip)skip.style.display='none';
  var actionBtns=document.querySelectorAll('#skipRow .btn-primary:not(#nextBtn)');actionBtns.forEach(function(b){b.style.display='none'});
}

function nextQuestion(){
  state.current++;
  if(state.current>=state.queue.length)return endQuiz();
  renderQuestion();
}

function endQuiz(){
  showScreen('resultScreen');
  const pct=state.maxScore?Math.round(state.score/state.maxScore*100):0;
  sendScoreToLV();
  trackSessionEnd();
  document.getElementById('resPts').textContent=state.score+' / '+state.maxScore;
  document.getElementById('resPct').textContent=pct+'%';

  let topicData={};
  state.queue.forEach((q,i)=>{
    if(i>=state.answered.length)return;
    if(state.answered[i].skipped)return;
    if(!topicData[q.topic])topicData[q.topic]={correct:0,total:0};
    topicData[q.topic].total++;
    if(state.answered[i].correct)topicData[q.topic].correct++;
  });

  let tHtml='';
  Object.keys(topicData).forEach(t=>{
    const d=topicData[t];const p=Math.round(d.correct/d.total*100);
    const cls=p>=70?'tg':p>=40?'ty':'tr';
    tHtml+='<div class="topic-row"><span class="topic-name">'+TOPICS[t].label+'</span>';
    tHtml+='<span class="topic-score">'+d.correct+'/'+d.total+'</span>';
    tHtml+='<div class="topic-bar"><div class="topic-bar-fill '+cls+'" style="width:'+p+'%"></div></div></div>';
  });
  document.getElementById('topicResults').innerHTML=tHtml;

  // Build full review of all questions
  let rHtml='';
  state.queue.forEach((q,i)=>{
    if(i>=state.answered.length) return;
    const a=state.answered[i];
    if(a.skipped){
      rHtml+='<div class="review-item ri-skipped">';
      rHtml+='<div class="ri-header"><span class="ri-num">#'+(i+1)+'</span><span class="ri-icon">‚è≠Ô∏è</span>';
      rHtml+='<span class="ri-topic">'+TOPICS[q.topic].short+'</span></div>';
      if(q.context)rHtml+='<div class="ri-context">'+q.context+'</div>';
      rHtml+='<div class="ri-question">'+getQuestionDisplay(q)+'</div>';
      rHtml+='</div>';
      return;
    }
    const cls=a.correct?'ri-correct':'ri-wrong';
    const icon=a.correct?'‚úÖ':'‚ùå';
    rHtml+='<div class="review-item '+cls+'">';
    rHtml+='<div class="ri-header"><span class="ri-num">#'+(i+1)+'</span><span class="ri-icon">'+icon+'</span>';
    rHtml+='<span class="ri-topic">'+TOPICS[q.topic].short+'</span></div>';
    if(q.context)rHtml+='<div class="ri-context">'+q.context+'</div>';
    rHtml+='<div class="ri-question">'+getQuestionDisplay(q)+'</div>';
    if(q.img)rHtml+='<div class="ri-img"><img src="'+q.img.src+'" alt="'+(q.img.alt||'')+'"></div>';
    rHtml+='<div class="ri-answer"><strong>L√∂sung:</strong> '+getCorrectAnswer(q)+'</div>';
    rHtml+='<div class="ri-explain">'+q.explain+'</div>';
    rHtml+='</div>';
  });
  document.getElementById('reviewList').innerHTML=rHtml;
}

function getQuestionDisplay(q){
  if(q.type==='fill'){
    return q.q.replace(/\{(\d+)\}/g,function(_,idx){
      const b=q.blanks[parseInt(idx)];
      return b?'<strong>['+b.answer+']</strong>':'[‚Ä¶]';
    });
  }
  return q.q;
}

function getCorrectAnswer(q){
  if(q.type==='mc'){ const opt=q.options.find(o=>o.v===q.correct); return q.correct+') '+(opt?opt.t:''); }
  if(q.type==='multi'){ return q.correct.map(function(v){ const opt=q.options.find(o=>o.v===v); return v+') '+(opt?opt.t:''); }).join(' ¬∑ '); }
  if(q.type==='tf'){ return q.correct?'Richtig':'Falsch'; }
  if(q.type==='fill'){ return q.blanks.map(function(b,i){return 'L√ºcke '+(i+1)+': '+b.answer}).join(' ¬∑ '); }
  if(q.type==='calc'){ return q.rows.map(function(r){return r.label+' '+r.answer+' '+r.unit}).join(' ¬∑ '); }
  if(q.type==='sort'){
    return q.categories.map(function(cat,ci){
      const items=q.items.filter(function(it){return it.cat===ci}).map(function(it){return it.t});
      return '<strong>'+cat+':</strong> '+items.join(', ');
    }).join(' ¬∑ ');
  }
  if(q.type==='open'){ return q.sample||'Siehe L√∂sungsvorschlag'; }
  return '';
}

function exportResults(){
  document.getElementById('printTitle').textContent=POOL_META.title;
  const now=new Date();
  document.getElementById('printMeta').textContent=POOL_META.meta+' ¬∑ '+now.toLocaleDateString('de-CH',{day:'2-digit',month:'2-digit',year:'numeric'})+', '+now.toLocaleTimeString('de-CH',{hour:'2-digit',minute:'2-digit'});
  window.addEventListener('afterprint',function onAP(){window.removeEventListener('afterprint',onAP);resetApp();},{once:true});
  window.print();
}

function resetApp(){
  state={mode:'mix',filters:{topics:new Set(),diffs:new Set(),types:new Set()},queue:[],current:0,score:0,maxScore:0,answered:[],wrong:[]};
  searchState.query=''; searchState.activeTags.clear();
  document.querySelectorAll('.search-tag').forEach(c=>c.classList.remove('active'));
  var si=document.getElementById('searchInput'); if(si){si.value='';}
  document.getElementById('searchClear').style.display='none';
  document.getElementById('searchResults').classList.remove('active');
  setMode('mix');
  showScreen('startScreen');
}

function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo({top:0});
}

function shuffle(arr){for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]]}return arr}

function renderContext(q){
  if(!q.context)return '';
  return '<div class="q-context"><div class="q-context-label">Sachverhalt</div>'+q.context+'</div>';
}

function renderImg(q){
  if(!q.img)return '';
  let h='<figure class="q-img">';
  h+='<img src="'+q.img.src+'" alt="'+(q.img.alt||'')+'" onclick="toggleZoom(this)" loading="lazy">';
  if(q.img.alt)h+='<figcaption>'+q.img.alt+'</figcaption>';
  h+='</figure>';
  return h;
}

function toggleZoom(img){ img.classList.toggle('zoomed'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LERNZIELE ‚Äî Mini-Modal (Topic) & Vollst√§ndiges Modal (Header)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openMini(key) {
  var t = TOPICS[key];
  if (!t || !t.lernziele || !t.lernziele.length) return;
  document.getElementById('lzMiniTitle').textContent = t.label;
  var html = '<ul class="lz-list">';
  t.lernziele.forEach(function(lz) { html += '<li>' + formatLernziel(lz) + '</li>'; });
  html += '</ul>';
  document.getElementById('lzMiniBody').innerHTML = html;
  document.getElementById('lzMiniOverlay').classList.add('active');
}
function closeMini() {
  document.getElementById('lzMiniOverlay').classList.remove('active');
}
function toggleFullModal() {
  var ov = document.getElementById('lzOverlay');
  if (ov.classList.contains('active')) { closeFullModal(); return; }
  buildFullModalContent();
  ov.classList.add('active');
}
function closeFullModal() {
  document.getElementById('lzOverlay').classList.remove('active');
}
function buildFullModalContent() {
  var body = document.getElementById('lzModalBody');
  var html = '';
  if (POOL_META.lernziele && POOL_META.lernziele.length) {
    html += '<div class="lz-pool-section"><h3>√úbergeordnete Lernziele</h3><ul class="lz-list">';
    POOL_META.lernziele.forEach(function(lz) { html += '<li>' + formatLernziel(lz) + '</li>'; });
    html += '</ul></div>';
  }
  var keys = Object.keys(TOPICS);
  var anyLZ = keys.some(function(k) { return TOPICS[k].lernziele && TOPICS[k].lernziele.length; });
  if (anyLZ) {
    html += '<div class="lz-topic-section"><h3>Lernziele pro Thema</h3>';
    keys.forEach(function(key) {
      var t = TOPICS[key];
      if (!t.lernziele || !t.lernziele.length) return;
      var count = QUESTIONS.filter(function(q) { return q.topic === key; }).length;
      html += '<div class="lz-topic">';
      html += '<div class="lz-topic-header" onclick="this.parentElement.classList.toggle(\'open\')">';
      html += '<span class="lz-topic-label">' + t.label + '</span>';
      html += '<span class="lz-topic-badge" onclick="event.stopPropagation();startFromLZ(\'' + key + '\')" title="Quiz starten" style="cursor:pointer">' + count + ' Fragen ‚ñ∂</span>';
      html += '<span class="lz-topic-chevron">‚ñ∂</span>';
      html += '</div><div class="lz-topic-body"><ul class="lz-list">';
      t.lernziele.forEach(function(lz) { html += '<li>' + formatLernziel(lz) + '</li>'; });
      html += '</ul>';
      html += '<button class="lz-topic-start" onclick="startFromLZ(\'' + key + '\')">';
      html += '<span class="lz-start-icon">‚ñ∂</span> ' + count + ' Fragen zu ¬´' + t.short + '¬ª √ºben</button>';
      html += '</div></div>';
    });
    html += '</div>';
  }
  body.innerHTML = html;
}
function formatLernziel(text) {
  var match = text.match(/\((K[1-6])\)\s*$/);
  if (match) {
    return text.replace(/\s*\(K[1-6]\)\s*$/, '') + ' <span class="lz-tax">' + match[1] + '</span>';
  }
  return text;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LERNZIEL-NAVIGATION ‚Äî Quiz aus Lernziel-Modal starten
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startFromLZ(topicKey) {
  closeFullModal();
  closeMini();
  setMode('focus');
  state.filters.topics.clear();
  document.querySelectorAll('#topicChips .chip').forEach(function(ch) { ch.classList.remove('active'); });
  state.filters.topics.add(topicKey);
  var chip = document.querySelector('#topicChips .chip[data-key="' + topicKey + '"]');
  if (chip) chip.classList.add('active');
  updateFilterCount();
  if (getFiltered().length > 0) startQuiz();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STICHWORTSUCHE ‚Äî Filter auf tags, q, explain, topic
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var searchState = { query: '', activeTags: new Set() };

function initSearch() {
  // Pr√ºfen ob Fragen Tags haben
  var hasTags = QUESTIONS.some(function(q) { return q.tags && q.tags.length; });
  var transChips = document.getElementById('transversalChips');
  // Transversale Bereiche pr√ºfen und Chips rendern
  var prefixes = [
    { prefix: 'bne:', label: 'üåç BNE', cls: 'tag-bne' },
    { prefix: 'idz:', label: 'üîó Interdisziplinarit√§t', cls: 'tag-idz' },
    { prefix: 'dig:', label: 'üíª Digitalit√§t', cls: 'tag-dig' },
    { prefix: 'pol:', label: 'üèõÔ∏è Politische Bildung', cls: 'tag-pol' }
  ];
  var hasAnyTransversal = false;
  transChips.innerHTML = '';
  prefixes.forEach(function(p) {
    var count = QUESTIONS.filter(function(q) { return q.tags && q.tags.some(function(t) { return t.startsWith(p.prefix); }); }).length;
    if (count > 0) {
      hasAnyTransversal = true;
      var chip = document.createElement('span');
      chip.className = 'search-tag ' + p.cls;
      chip.dataset.prefix = p.prefix;
      chip.textContent = p.label + ' (' + count + ')';
      chip.onclick = function() { toggleTransversalTag(chip, p.prefix); };
      transChips.appendChild(chip);
    }
  });
  // Suchcard immer sichtbar (Suchfeld + transversale Chips)
}

function onSearchInput(val) {
  searchState.query = val.trim().toLowerCase();
  document.getElementById('searchClear').style.display = val.length > 0 ? '' : 'none';
  applySearchFilter();
}

function clearSearch() {
  document.getElementById('searchInput').value = '';
  searchState.query = '';
  document.getElementById('searchClear').style.display = 'none';
  applySearchFilter();
}

function toggleTransversalTag(chip, prefix) {
  chip.classList.toggle('active');
  if (chip.classList.contains('active')) {
    searchState.activeTags.add(prefix);
  } else {
    searchState.activeTags.delete(prefix);
  }
  applySearchFilter();
}

function matchesSearch(q) {
  var queryMatch = true;
  var tagMatch = true;
  // Text-Suche
  if (searchState.query.length >= 2) {
    var s = searchState.query;
    var inQ = (q.q || '').toLowerCase().indexOf(s) !== -1;
    var inExplain = (q.explain || '').toLowerCase().indexOf(s) !== -1;
    var inTopic = (TOPICS[q.topic] ? TOPICS[q.topic].label.toLowerCase().indexOf(s) !== -1 : false);
    var inTags = q.tags ? q.tags.some(function(t) { return t.toLowerCase().indexOf(s) !== -1; }) : false;
    var inContext = (q.context || '').toLowerCase().indexOf(s) !== -1;
    queryMatch = inQ || inExplain || inTopic || inTags || inContext;
  }
  // Transversale Tags
  if (searchState.activeTags.size > 0) {
    if (!q.tags || !q.tags.length) { tagMatch = false; }
    else {
      tagMatch = false;
      searchState.activeTags.forEach(function(prefix) {
        if (q.tags.some(function(t) { return t.startsWith(prefix); })) tagMatch = true;
      });
    }
  }
  return queryMatch && tagMatch;
}

function applySearchFilter() {
  var hasSearch = searchState.query.length >= 2 || searchState.activeTags.size > 0;
  var resultsEl = document.getElementById('searchResults');
  if (!hasSearch) {
    resultsEl.classList.remove('active');
    resultsEl.textContent = '';
    updateFilterCount();
    return;
  }
  var matched = getFiltered().filter(matchesSearch);
  resultsEl.classList.add('active');
  resultsEl.textContent = 'üîç ' + matched.length + ' Aufgaben' + (searchState.query ? ' f√ºr ¬´' + searchState.query + '¬ª' : '');
  updateFilterCount();
}

// Override getFiltered to include search
var _origGetFiltered = null;

function patchGetFiltered() {
  _origGetFiltered = getFiltered;
  getFiltered = function() {
    var base = _origGetFiltered();
    if (searchState.query.length >= 2 || searchState.activeTags.size > 0) {
      return base.filter(matchesSearch);
    }
    return base;
  };
}
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') { closeMini(); closeFullModal(); closeReport(); closeHelp(); }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HILFE-MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var helpLoaded = false;
function openHelp() {
  var overlay = document.getElementById('helpOverlay');
  overlay.classList.add('active');
  document.body.style.overflow = 'hidden';
  if (!helpLoaded) {
    fetch('help-content.html', {cache: 'no-cache'}).then(function(r) { return r.text(); }).then(function(html) {
      document.getElementById('helpModalBody').innerHTML = html;
      helpLoaded = true;
    }).catch(function() {
      document.getElementById('helpModalBody').innerHTML = '<p>Anleitung konnte nicht geladen werden.</p>';
    });
  }
}
function closeHelp() {
  document.getElementById('helpOverlay').classList.remove('active');
  document.body.style.overflow = '';
}
</script>

<!-- REPORT ‚Äî In-App Modal -->
<div class="report-overlay" id="reportOverlay" onclick="if(event.target===this)closeReport()">
  <div class="report-modal">
    <div class="report-modal-header">
      <h3>‚ö†Ô∏è Problem melden</h3>
      <button class="report-modal-close" onclick="closeReport()">&times;</button>
    </div>
    <div class="report-modal-body">
      <div id="reportForm">
        <div class="report-meta" id="reportMeta"></div>
        <div class="report-label">Kategorie *</div>
        <div class="report-cats">
          <span class="report-cat" onclick="selectReportCat(this)">Fachlicher Fehler</span>
          <span class="report-cat" onclick="selectReportCat(this)">Technisches Problem</span>
          <span class="report-cat" onclick="selectReportCat(this)">Unklar formuliert</span>
          <span class="report-cat" onclick="selectReportCat(this)">Anderes</span>
        </div>
        <div class="report-label">Beschreibung (optional)</div>
        <textarea class="report-textarea" id="reportComment" placeholder="Was genau ist das Problem?" maxlength="500"></textarea>
        <div class="report-error" id="reportError"></div>
        <div class="report-actions">
          <button class="btn btn-outline" onclick="closeReport()">Abbrechen</button>
          <button class="btn btn-primary" id="reportSendBtn" onclick="sendReport()">üì® Senden</button>
        </div>
      </div>
      <div class="report-success" id="reportDone" style="display:none">
        <div class="success-icon">‚úÖ</div>
        <p><strong>Vielen Dank!</strong><br>Deine Meldung wurde gesendet.</p>
      </div>
    </div>
  </div>
</div>

<!-- LERNZIELE ‚Äî Mini-Modal (Topic-Lernziele) -->
<div class="lz-mini-overlay" id="lzMiniOverlay" onclick="if(event.target===this)closeMini()">
  <div class="lz-mini-modal">
    <div class="lz-mini-header">
      <span class="lz-color-dot"></span>
      <h3 id="lzMiniTitle"></h3>
      <button class="lz-mini-close" onclick="closeMini()">&times;</button>
    </div>
    <div class="lz-mini-body" id="lzMiniBody"></div>
  </div>
</div>

<!-- LERNZIELE ‚Äî Vollst√§ndiges Modal (Header) -->
<div class="lz-overlay" id="lzOverlay" onclick="if(event.target===this)closeFullModal()">
  <div class="lz-modal">
    <div class="lz-modal-header">
      <h2>üèÅ Lernziele</h2>
      <button class="lz-modal-close" onclick="closeFullModal()">&times;</button>
    </div>
    <div class="lz-modal-body" id="lzModalBody"></div>
  </div>
</div>

<!-- HILFE-MODAL -->
<div class="help-overlay" id="helpOverlay" onclick="if(event.target===this)closeHelp()">
  <div class="help-modal">
    <div class="help-modal-header">
      <h2>‚ùì Anleitung</h2>
      <button class="help-modal-close" onclick="closeHelp()">&times;</button>
    </div>
    <div class="help-modal-body" id="helpModalBody">Wird geladen‚Ä¶</div>
  </div>
</div>

</body>
</html>
