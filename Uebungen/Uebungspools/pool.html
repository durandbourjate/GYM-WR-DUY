<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>√úbungspool laden‚Ä¶</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400&family=DM+Mono:wght@400;500&display=swap');
:root{
--c-bg:#f0f2f5;--c-surface:#fff;--c-primary:#f89907;--c-primary-light:#ffb74d;
--c-accent:#e8a838;--c-accent-light:#fef3c7;--c-success:#16a34a;--c-success-bg:#f0fdf4;
--c-error:#dc2626;--c-error-bg:#fef2f2;--c-info:#2563eb;--c-info-bg:#eff6ff;
--c-text:#1e293b;--c-text-soft:#64748b;--c-border:#e2e8f0;--radius:10px;
--shadow-sm:0 1px 3px rgba(0,0,0,.06);--shadow-md:0 4px 12px rgba(0,0,0,.08);
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',system-ui,sans-serif;background:var(--c-bg);color:var(--c-text);line-height:1.6;min-height:100vh}
.app-header{background:linear-gradient(135deg,var(--c-primary),var(--c-primary-light));color:#fff;padding:20px 24px;position:sticky;top:0;z-index:100;box-shadow:0 2px 12px rgba(0,0,0,.15);display:flex;align-items:center;gap:16px}
.home-btn{display:flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:8px;background:rgba(255,255,255,.2);color:#fff;text-decoration:none;font-size:1.1rem;flex-shrink:0;transition:.15s}
.home-btn:hover{background:rgba(255,255,255,.35)}
.app-header h1{font-size:1.25rem;font-weight:700;letter-spacing:-.02em}
.app-header .meta{font-size:.8rem;opacity:.75;margin-top:2px}
.container{max-width:720px;margin:0 auto;padding:20px 16px 100px}
.screen{display:none}.screen.active{display:block}
.card{background:var(--c-surface);border-radius:var(--radius);padding:24px;margin-bottom:16px;box-shadow:var(--shadow-sm);border:1px solid var(--c-border)}
.card h2{font-size:1.05rem;font-weight:700;margin-bottom:14px;color:var(--c-text)}
.mode-cards{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:8px}
.mode-card{border:2px solid var(--c-border);border-radius:var(--radius);padding:16px;cursor:pointer;text-align:center;transition:.2s}
.mode-card:hover{border-color:var(--c-primary-light);background:#f8fafc}
.mode-card.active{border-color:var(--c-primary);background:var(--c-info-bg)}
.mode-card .mode-icon{font-size:1.8rem;margin-bottom:6px}
.mode-card .mode-title{font-weight:700;font-size:.95rem}
.mode-card .mode-desc{font-size:.78rem;color:var(--c-text-soft);margin-top:4px}
.chips{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
.chip{display:inline-flex;align-items:center;padding:6px 14px;border-radius:20px;font-size:.82rem;font-weight:500;cursor:pointer;border:2px solid var(--c-border);background:#fff;transition:.15s;user-select:none}
.chip:hover{border-color:var(--c-primary-light)}
.chip.active{background:var(--c-primary);color:#fff;border-color:var(--c-primary)}
.filter-count{font-family:'DM Mono',monospace;font-size:.95rem;font-weight:600;color:var(--c-text);margin-top:8px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 24px;border-radius:var(--radius);font-family:inherit;font-size:.95rem;font-weight:600;cursor:pointer;border:none;transition:.2s}
.btn-primary{background:var(--c-primary);color:#fff}.btn-primary:hover{background:var(--c-primary-light)}
.btn-primary:disabled{opacity:.4;cursor:not-allowed}
.btn-accent{background:var(--c-accent);color:#fff}.btn-accent:hover{filter:brightness(1.05)}
.btn-outline{background:transparent;border:2px solid var(--c-border);color:var(--c-text)}.btn-outline:hover{border-color:var(--c-primary);color:var(--c-primary)}
.btn-block{width:100%;justify-content:center}
.progress-bar-wrap{background:var(--c-border);border-radius:20px;height:8px;margin:12px 0;overflow:hidden}
.progress-bar-fill{height:100%;background:var(--c-accent);border-radius:20px;transition:width .4s ease}
.quiz-meta{display:flex;justify-content:space-between;align-items:center;font-size:.85rem;color:var(--c-text-soft);margin-bottom:4px}
.quiz-meta .score{font-family:'DM Mono',monospace;font-weight:600;color:var(--c-text)}
.q-badges{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
.badge{font-size:.7rem;font-weight:600;padding:3px 10px;border-radius:12px;text-transform:uppercase;letter-spacing:.03em}
.badge-topic{background:var(--c-info-bg);color:var(--c-info)}
.badge-diff1{background:#f0fdf4;color:#16a34a}.badge-diff2{background:#fef3c7;color:#b45309}.badge-diff3{background:#fef2f2;color:#dc2626}
.badge-tax{background:#f3e8ff;color:#7c3aed}
.badge-type{background:#f1f5f9;color:#475569}
.q-text{font-size:1rem;font-weight:500;margin-bottom:18px;line-height:1.65}
.mc-options{display:flex;flex-direction:column;gap:10px}
.mc-opt{display:flex;align-items:flex-start;gap:12px;padding:14px 16px;border:2px solid var(--c-border);border-radius:var(--radius);cursor:pointer;transition:.15s;background:#fff}
.mc-opt:hover{border-color:var(--c-primary-light);background:#f8fafc}
.mc-opt.selected{border-color:var(--c-info);background:var(--c-info-bg)}
.mc-opt.correct{border-color:var(--c-success);background:var(--c-success-bg)}
.mc-opt.wrong{border-color:var(--c-error);background:var(--c-error-bg)}
.mc-opt .opt-letter{font-family:'DM Mono',monospace;font-weight:700;font-size:.85rem;min-width:24px;height:24px;display:flex;align-items:center;justify-content:center;border-radius:50%;background:var(--c-border);color:var(--c-text-soft);flex-shrink:0}
.mc-opt.selected .opt-letter{background:var(--c-info);color:#fff}
.mc-opt.correct .opt-letter{background:var(--c-success);color:#fff}
.mc-opt.wrong .opt-letter{background:var(--c-error);color:#fff}
.mc-opt .opt-text{font-size:.92rem;line-height:1.5}
.tf-btns{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.tf-btn{padding:16px;border:2px solid var(--c-border);border-radius:var(--radius);text-align:center;font-weight:600;font-size:1rem;cursor:pointer;transition:.15s;background:#fff}
.tf-btn:hover{border-color:var(--c-primary-light)}.tf-btn.selected{border-color:var(--c-info);background:var(--c-info-bg)}
.tf-btn.correct{border-color:var(--c-success);background:var(--c-success-bg)}
.tf-btn.wrong{border-color:var(--c-error);background:var(--c-error-bg)}
.fill-input{border:none;border-bottom:2px solid var(--c-primary);background:var(--c-info-bg);padding:4px 8px;font-family:inherit;font-size:.92rem;font-weight:500;min-width:120px;outline:none;border-radius:4px 4px 0 0;transition:.2s}
.fill-input:focus{border-color:var(--c-accent);background:var(--c-accent-light)}
.fill-input.correct{border-color:var(--c-success);background:var(--c-success-bg)}
.fill-input.wrong{border-color:var(--c-error);background:var(--c-error-bg)}
.calc-rows{display:flex;flex-direction:column;gap:10px}
.calc-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.calc-row label{font-size:.9rem;flex:1;min-width:150px}
.calc-row input{width:100px;padding:8px 10px;border:2px solid var(--c-border);border-radius:6px;font-family:'DM Mono',monospace;font-size:.92rem;text-align:right;outline:none}
.calc-row input:focus{border-color:var(--c-primary)}
.calc-row .unit{font-size:.85rem;color:var(--c-text-soft);min-width:30px}
.calc-row input.correct{border-color:var(--c-success);background:var(--c-success-bg)}
.calc-row input.wrong{border-color:var(--c-error);background:var(--c-error-bg)}
.open-answer{width:100%;min-height:80px;padding:12px;border:2px solid var(--c-border);border-radius:var(--radius);font-family:inherit;font-size:.92rem;line-height:1.5;resize:vertical;outline:none;background:#fff}
.open-answer:focus{border-color:var(--c-primary)}
.open-sample{margin-top:12px;padding:14px;border-radius:var(--radius);background:var(--c-info-bg);border-left:4px solid var(--c-info);font-size:.9rem;line-height:1.6;display:none}
.open-sample.show{display:block}
.open-sample-title{font-weight:700;color:var(--c-info);margin-bottom:4px}
.open-self{display:flex;gap:10px;margin-top:12px;display:none}
.open-self.show{display:flex}
.open-self .btn{flex:1}
.sort-pool{display:flex;flex-wrap:wrap;gap:8px;min-height:48px;padding:12px;background:var(--c-bg);border-radius:var(--radius);margin-bottom:12px}
.sort-item{padding:8px 14px;border-radius:8px;font-size:.85rem;font-weight:500;cursor:pointer;transition:.2s;border:2px solid var(--c-border);background:#fff;user-select:none}
.sort-item:hover{border-color:var(--c-primary-light)}.sort-item.picked{border-color:var(--c-primary);background:var(--c-primary);color:#fff;box-shadow:0 0 0 3px color-mix(in srgb,var(--c-primary) 25%,transparent)}
.sort-cats{display:grid;gap:12px;margin-top:8px}
.sort-cat{border:2px dashed var(--c-border);border-radius:var(--radius);padding:12px;min-height:60px;transition:.2s}
.sort-cat:hover{border-color:var(--c-primary-light)}
.sort-cat.active{border-color:var(--c-primary);background:color-mix(in srgb,var(--c-primary) 8%,transparent)}
.sort-cat-title{font-weight:700;font-size:.85rem;color:var(--c-text);margin-bottom:8px}
.sort-cat-items{display:flex;flex-wrap:wrap;gap:6px}
.sort-cat-item{padding:6px 12px;border-radius:6px;font-size:.82rem;font-weight:500;cursor:pointer;background:var(--c-primary);color:#fff;transition:.15s}
.sort-cat-item:hover{opacity:.85}
.sort-cat-item.correct-item{background:var(--c-success)}.sort-cat-item.wrong-item{background:var(--c-error)}
.feedback{margin-top:16px;padding:16px;border-radius:var(--radius);font-size:.9rem;line-height:1.6;display:none}
.feedback.show{display:block}
.feedback.correct{background:var(--c-success-bg);border-left:4px solid var(--c-success)}
.feedback.wrong{background:var(--c-error-bg);border-left:4px solid var(--c-error)}
.feedback-title{font-weight:700;margin-bottom:4px}
.quiz-actions{display:flex;gap:10px;margin-top:18px;flex-wrap:wrap}
.result-score{text-align:center;padding:24px;font-family:'DM Mono',monospace}
.result-score .big{font-size:2.8rem;font-weight:700;color:var(--c-text)}
.result-score .pct{font-size:1.4rem;color:var(--c-text-soft)}
.topic-results{display:flex;flex-direction:column;gap:8px;margin-top:12px}
.topic-row{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:8px;background:var(--c-bg)}
.topic-row .topic-name{flex:1;font-size:.88rem;font-weight:500}
.topic-row .topic-score{font-family:'DM Mono',monospace;font-weight:600;font-size:.85rem}
.topic-row .topic-bar{width:60px;height:6px;background:var(--c-border);border-radius:3px;overflow:hidden}
.topic-row .topic-bar-fill{height:100%;border-radius:3px}
.tg{background:var(--c-success)}.ty{background:var(--c-accent)}.tr{background:var(--c-error)}
.wrong-list{margin-top:12px}
.wrong-item{padding:14px;border-radius:var(--radius);margin-bottom:10px;background:var(--c-bg);border-left:3px solid var(--c-error)}
.wrong-item .wq{font-weight:600;font-size:.9rem;margin-bottom:4px}
.wrong-item .wa{font-size:.85rem;color:var(--c-text-soft);line-height:1.5}
.review-list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
.review-item{padding:14px;border-radius:var(--radius);background:var(--c-bg);border-left:3px solid var(--c-border)}
.review-item.ri-correct{border-left-color:var(--c-success)}
.review-item.ri-wrong{border-left-color:var(--c-error)}
.review-item.ri-skipped{border-left-color:var(--c-text-soft)}
.ri-header{display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap}
.ri-num{font-family:'DM Mono',monospace;font-weight:700;font-size:.8rem;color:var(--c-text-soft)}
.ri-icon{font-size:.9rem}
.ri-topic{font-size:.7rem;font-weight:600;padding:2px 8px;border-radius:10px;background:var(--c-info-bg);color:var(--c-info)}
.ri-question{font-weight:600;font-size:.9rem;margin-bottom:8px;line-height:1.5}
.ri-answer{font-size:.85rem;line-height:1.5;color:var(--c-text)}
.ri-answer strong{font-weight:600}
.ri-explain{font-size:.82rem;color:var(--c-text-soft);margin-top:6px;line-height:1.5;padding-top:6px;border-top:1px solid var(--c-border)}
/* Loading screen */
.loading{text-align:center;padding:60px 20px}
.loading .spinner{width:40px;height:40px;border:4px solid var(--c-border);border-top-color:var(--c-primary);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 16px}
@keyframes spin{to{transform:rotate(360deg)}}
.loading .msg{color:var(--c-text-soft);font-size:.95rem}
.error{text-align:center;padding:60px 20px;color:var(--c-error)}
.error h2{margin-bottom:8px}
@media(prefers-color-scheme:dark){
:root{
--c-bg:#0f1117;--c-surface:#1a1d27;--c-primary:#f89907;--c-primary-light:#ffb74d;
--c-accent:#e8a838;--c-accent-light:#3d2e10;--c-success:#22c55e;--c-success-bg:#0a2618;
--c-error:#ef4444;--c-error-bg:#2a0f0f;--c-info:#60a5fa;--c-info-bg:#0f1d3a;
--c-text:#e2e8f0;--c-text-soft:#94a3b8;--c-border:#2d3348;
--shadow-sm:0 1px 3px rgba(0,0,0,.3);--shadow-md:0 4px 12px rgba(0,0,0,.4);
}
.app-header{box-shadow:0 2px 12px rgba(0,0,0,.4)}
.mc-opt,.tf-btn,.sort-item{background:var(--c-surface)}
.mc-opt:hover,.mode-card:hover{background:#1f2333}
.mc-opt .opt-letter{background:var(--c-border);color:var(--c-text-soft)}
.chip{background:var(--c-surface)}
.badge-diff1{background:#0a2618;color:#22c55e}.badge-diff2{background:#3d2e10;color:#e8a838}.badge-diff3{background:#2a0f0f;color:#ef4444}
.badge-tax{background:#1a0f2e;color:#a78bfa}
.badge-type{background:#1a1d27;color:#94a3b8}
.topic-row{background:var(--c-surface)}
.wrong-item{background:var(--c-surface)}
.review-item{background:var(--c-surface)}
.calc-row input{background:var(--c-surface);color:var(--c-text);border-color:var(--c-border)}
.open-answer{background:var(--c-surface);color:var(--c-text);border-color:var(--c-border)}
}
@media print{
body{min-height:auto!important;background:#fff!important}
.container{padding:0 16px!important;max-width:100%!important}
.app-header,.quiz-actions,#startScreen,#loadingScreen,#errorScreen,#quizScreen{display:none!important;height:0!important;overflow:hidden!important;padding:0!important;margin:0!important}
#resultScreen{display:block!important}
#resultScreen .btn{display:none!important}
.card{break-inside:avoid;page-break-inside:avoid;box-shadow:none;border:1px solid #ccc;background:#fff!important}
.print-header{display:block!important;text-align:center;padding:16px 0 8px;border-bottom:2px solid #333;margin-bottom:16px}
.print-header h1{font-size:1.3rem;font-weight:700;margin:0}.print-header .print-meta{font-size:.8rem;color:#666;margin-top:4px}
.review-item{break-inside:avoid;page-break-inside:avoid;border:1px solid #ddd;border-left:3px solid #999;background:#fff!important}
.review-item.ri-correct{border-left-color:#16a34a}
.review-item.ri-wrong{border-left-color:#dc2626}
.ri-topic{border:1px solid #ccc}
.topic-row{background:#f5f5f5!important}
.topic-bar{print-color-adjust:exact;-webkit-print-color-adjust:exact}
.topic-bar-fill{print-color-adjust:exact;-webkit-print-color-adjust:exact}
}
.print-header{display:none}
@media(max-width:500px){.mode-cards{grid-template-columns:1fr}.container{padding:12px 10px 80px}.card{padding:18px}.tf-btns{grid-template-columns:1fr}}
</style>
</head>
<body>

<header class="app-header">
<a href="index.html" class="home-btn" title="Zur √úbersicht">üè†</a>
<div>
<h1 id="poolTitle">√úbungspool laden‚Ä¶</h1>
<div class="meta" id="poolMeta">Gymnasium Hofwil ¬∑ Individuell √ºben</div>
</div>
</header>
<div class="container">

<!-- ‚ïê‚ïê‚ïê Loading ‚ïê‚ïê‚ïê -->
<div id="loadingScreen" class="screen active">
<div class="card loading">
<div class="spinner"></div>
<div class="msg">√úbungspool wird geladen‚Ä¶</div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê Error ‚ïê‚ïê‚ïê -->
<div id="errorScreen" class="screen">
<div class="card error">
<h2>‚ö†Ô∏è Pool nicht gefunden</h2>
<p id="errorMsg">Der gew√ºnschte √úbungspool konnte nicht geladen werden.</p>
<p style="margin-top:12px"><a href="index.html">‚Üê Zur √úbersicht</a></p>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê Startbildschirm ‚ïê‚ïê‚ïê -->
<div id="startScreen" class="screen">
<div class="card">
<h2>üìã Modus w√§hlen</h2>
<div class="mode-cards">
<div class="mode-card" data-mode="focus" onclick="setMode('focus')">
<div class="mode-icon">üéØ</div>
<div class="mode-title">Fokus</div>
<div class="mode-desc">Gezielt ein Thema √ºben, nach Schwierigkeit sortiert</div>
</div>
<div class="mode-card" data-mode="mix" onclick="setMode('mix')">
<div class="mode-icon">üîÄ</div>
<div class="mode-title">Mix</div>
<div class="mode-desc">Zuf√§llige Auswahl quer durch alle Themen</div>
</div>
</div>
</div>
<div class="card">
<h2>üìö Unterthema</h2>
<div class="chips" id="topicChips"></div>
</div>
<div class="card">
<h2>üìä Schwierigkeit</h2>
<div class="chips" id="diffChips"></div>
</div>
<div class="card">
<h2>‚úèÔ∏è Fragetyp</h2>
<div class="chips" id="typeChips"></div>
</div>
<div class="card" style="text-align:center">
<div class="filter-count" id="filterCount">0 Aufgaben verf√ºgbar</div>
<button class="btn btn-primary btn-block" id="startBtn" style="margin-top:14px" onclick="startQuiz()" disabled>√úbung starten</button>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê Quiz-Bildschirm ‚ïê‚ïê‚ïê -->
<div id="quizScreen" class="screen">
<div class="card">
<div class="quiz-meta">
<span id="qProgress">1 / 10</span>
<span class="score" id="qScore">0 Punkte</span>
</div>
<div class="progress-bar-wrap"><div class="progress-bar-fill" id="progressBar" style="width:0%"></div></div>
</div>
<div class="card" id="questionCard"></div>
<div class="quiz-actions" id="quizActions">
<button class="btn btn-accent" id="nextBtn" onclick="nextQuestion()" style="display:none">N√§chste Aufgabe ‚Üí</button>
<button class="btn btn-outline" onclick="endQuiz()">√úbung beenden</button>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê Ergebnis ‚ïê‚ïê‚ïê -->
<div id="resultScreen" class="screen">
<div class="print-header"><h1 id="printTitle"></h1><div class="print-meta" id="printMeta"></div></div>
<div class="card">
<div class="result-score">
<div class="big" id="resPts">0/0</div>
<div class="pct" id="resPct">0%</div>
</div>
</div>
<div class="card"><h2>üìä Nach Unterthema</h2><div id="topicResults" class="topic-results"></div></div>
<div class="card" id="reviewCard"><h2>üìã Alle Fragen & L√∂sungen</h2><div id="reviewList" class="review-list"></div></div>
<div class="card" style="text-align:center">
<button class="btn btn-primary" onclick="exportResults()" style="margin-right:10px">üìÑ Als PDF speichern</button>
<button class="btn btn-outline" onclick="resetApp()">Neue √úbung starten</button>
</div>
</div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// POOL LOADER ‚Äî loads data from external JS file
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Color schemes per Fachbereich
const COLOR_SCHEMES = {
  vwl:   { primary: '#f89907', primaryLight: '#ffb74d' },
  bwl:   { primary: '#01a9f4', primaryLight: '#4fc3f7' },
  recht: { primary: '#73ab2c', primaryLight: '#8bc34a' }
};

// Labels (shared across all pools)
const DIFF_LABELS = {1:"‚≠ê Einfach",2:"‚≠ê‚≠ê Mittel",3:"‚≠ê‚≠ê‚≠ê Schwer"};
const TYPE_LABELS = {mc:"üìù Multiple Choice",tf:"‚úì‚úó Richtig/Falsch",fill:"üìñ L√ºckentext",calc:"üî¢ Berechnung",sort:"üîÄ Zuordnung",open:"‚úèÔ∏è Offene Frage"};

(async function loadPool() {
  const params = new URLSearchParams(window.location.search);
  const poolId = params.get('pool');

  if (!poolId) {
    showError('Kein Pool angegeben. Bitte verwenden Sie einen Link mit ?pool=NAME');
    return;
  }

  try {
    // Load the pool's JS file via fetch + eval to avoid const redeclaration issues
    const response = await fetch('config/' + poolId + '.js');
    if (!response.ok) throw new Error('Datei nicht gefunden: config/' + poolId + '.js');
    const code = await response.text();

    // Execute in global scope
    const scriptEl = document.createElement('script');
    scriptEl.textContent = code;
    document.head.appendChild(scriptEl);

    // Verify data was loaded (use window to check globals)
    if (typeof window.POOL_META === 'undefined' || typeof window.TOPICS === 'undefined' || typeof window.QUESTIONS === 'undefined') {
      throw new Error('Pool-Daten unvollst√§ndig');
    }

    // Apply metadata
    document.getElementById('poolTitle').textContent = POOL_META.title;
    document.getElementById('poolMeta').textContent = POOL_META.meta;
    document.title = POOL_META.title + ' | Gymnasium Hofwil';

    // Apply color scheme
    const colors = COLOR_SCHEMES[POOL_META.color] || COLOR_SCHEMES.vwl;
    document.documentElement.style.setProperty('--c-primary', colors.primary);
    document.documentElement.style.setProperty('--c-primary-light', colors.primaryLight);

    // Also apply for dark mode (same colors work in both modes)
    // The CSS media query already handles the other variables

    // Show the start screen
    document.getElementById('loadingScreen').classList.remove('active');
    document.getElementById('startScreen').classList.add('active');
    init();

  } catch (err) {
    showError(err.message);
  }
})();

function showError(msg) {
  document.getElementById('loadingScreen').classList.remove('active');
  document.getElementById('errorMsg').textContent = msg;
  document.getElementById('errorScreen').classList.add('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let state={mode:null,filters:{topics:new Set(),diffs:new Set(),types:new Set()},queue:[],current:0,score:0,maxScore:0,answered:[],wrong:[]};
let pickedSortItem=null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function init(){
  buildChips('topicChips',TOPICS,'topics',t=>TOPICS[t].short);
  buildChips('diffChips',DIFF_LABELS,'diffs',d=>DIFF_LABELS[d]);
  buildChips('typeChips',TYPE_LABELS,'types',t=>TYPE_LABELS[t]);
  updateFilterCount();
  applyDeepLink();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DEEP LINK ‚Äî Direktzugriff auf Unterthemen via URL-Parameter
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Nutzung:
//   ?pool=vwl_bip&topic=2            ‚Üí Thema 2 vorausgew√§hlt (Fokus-Modus)
//   ?pool=vwl_bip&topic=2&start=1    ‚Üí Startet direkt ins Quiz
//   ?pool=vwl_bip&topic=2&diff=1     ‚Üí Nur einfache Fragen
//   ?pool=vwl_bip&topic=2&diff=1,2   ‚Üí Einfach + Mittel
//   ?pool=vwl_bip&topic=2&type=mc,tf ‚Üí Nur MC und R/F
function applyDeepLink(){
  const params=new URLSearchParams(window.location.search);
  const topicParam=params.get('topic');
  if(!topicParam)return;

  // Validate topic exists
  const topicKeys=topicParam.split(',').filter(k=>TOPICS[k]);
  if(topicKeys.length===0)return;

  // Set focus mode (most logical for deep links)
  setMode('focus');

  // Clear auto-selected topics from setMode, then select only the linked ones
  state.filters.topics.clear();
  document.querySelectorAll('#topicChips .chip').forEach(ch=>ch.classList.remove('active'));
  topicKeys.forEach(k=>{
    state.filters.topics.add(k);
    const chip=document.querySelector('#topicChips .chip[data-key="'+k+'"]');
    if(chip)chip.classList.add('active');
  });

  // Optional: Filter by difficulty
  const diffParam=params.get('diff');
  if(diffParam){
    state.filters.diffs.clear();
    document.querySelectorAll('#diffChips .chip').forEach(ch=>ch.classList.remove('active'));
    diffParam.split(',').filter(d=>DIFF_LABELS[d]).forEach(d=>{
      state.filters.diffs.add(d);
      const chip=document.querySelector('#diffChips .chip[data-key="'+d+'"]');
      if(chip)chip.classList.add('active');
    });
  }

  // Optional: Filter by question type
  const typeParam=params.get('type');
  if(typeParam){
    state.filters.types.clear();
    document.querySelectorAll('#typeChips .chip').forEach(ch=>ch.classList.remove('active'));
    typeParam.split(',').filter(t=>TYPE_LABELS[t]).forEach(t=>{
      state.filters.types.add(t);
      const chip=document.querySelector('#typeChips .chip[data-key="'+t+'"]');
      if(chip)chip.classList.add('active');
    });
  }

  updateFilterCount();

  // Auto-start if requested
  if(params.get('start')==='1'&&getFiltered().length>0){
    startQuiz();
  }
}

function buildChips(containerId,obj,filterKey,labelFn){
  const c=document.getElementById(containerId);
  c.innerHTML='';
  Object.keys(obj).forEach(k=>{
    const ch=document.createElement('span');
    ch.className='chip';
    ch.textContent=labelFn(k);
    ch.dataset.key=k;
    ch.onclick=()=>toggleChip(ch,filterKey,k);
    c.appendChild(ch);
  });
}

function setMode(m){
  state.mode=m;
  document.querySelectorAll('.mode-card').forEach(c=>c.classList.toggle('active',c.dataset.mode===m));
  if(m==='mix'){
    ['topicChips','diffChips','typeChips'].forEach(id=>{
      document.querySelectorAll('#'+id+' .chip').forEach(ch=>{
        ch.classList.add('active');
        state.filters[id==='topicChips'?'topics':id==='diffChips'?'diffs':'types'].add(ch.dataset.key);
      });
    });
  } else {
    ['topicChips','diffChips'].forEach(id=>{
      document.querySelectorAll('#'+id+' .chip').forEach(ch=>ch.classList.remove('active'));
      state.filters[id==='topicChips'?'topics':'diffs'].clear();
    });
    document.querySelectorAll('#typeChips .chip').forEach(ch=>{
      ch.classList.add('active');
      state.filters.types.add(ch.dataset.key);
    });
  }
  updateFilterCount();
}

function toggleChip(el,filterKey,key){
  el.classList.toggle('active');
  if(el.classList.contains('active'))state.filters[filterKey].add(key);
  else state.filters[filterKey].delete(key);
  updateFilterCount();
}

function getFiltered(){
  return QUESTIONS.filter(q=>
    (state.filters.topics.size===0||state.filters.topics.has(q.topic))&&
    (state.filters.diffs.size===0||state.filters.diffs.has(String(q.diff)))&&
    (state.filters.types.size===0||state.filters.types.has(q.type))
  );
}

function updateFilterCount(){
  const n=getFiltered().length;
  document.getElementById('filterCount').textContent=n+' Aufgabe'+(n!==1?'n':'')+' verf√ºgbar';
  document.getElementById('startBtn').disabled=n===0||!state.mode;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// QUIZ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startQuiz(){
  let q=getFiltered();
  if(state.mode==='focus')q.sort((a,b)=>a.diff-b.diff);
  else shuffle(q);
  state.queue=q;state.current=0;state.score=0;state.maxScore=0;state.answered=[];state.wrong=[];
  showScreen('quizScreen');
  renderQuestion();
}

function renderQuestion(){
  const q=state.queue[state.current];
  const total=state.queue.length;
  document.getElementById('qProgress').textContent=(state.current+1)+' / '+total;
  document.getElementById('qScore').textContent=state.score+' Punkte';
  document.getElementById('progressBar').style.width=((state.current)/total*100)+'%';
  document.getElementById('nextBtn').style.display='none';

  let html='<div class="q-badges">';
  html+='<span class="badge badge-topic">'+TOPICS[q.topic].short+'</span>';
  html+='<span class="badge badge-diff'+q.diff+'">'+DIFF_LABELS[q.diff]+'</span>';
  html+='<span class="badge badge-tax">'+q.tax+'</span>';
  html+='<span class="badge badge-type">'+TYPE_LABELS[q.type]+'</span>';
  html+='</div>';
  html+='<div class="q-text">'+q.q+'</div>';

  if(q.type==='mc'){
    html+='<div class="mc-options">';
    q.options.forEach(o=>{
      html+='<div class="mc-opt" data-val="'+o.v+'" onclick="answerMC(this,\''+q.id+'\',\''+o.v+'\')">';
      html+='<span class="opt-letter">'+o.v+'</span><span class="opt-text">'+o.t+'</span></div>';
    });
    html+='</div>';
  } else if(q.type==='tf'){
    html+='<div class="tf-btns"><div class="tf-btn" onclick="answerTF(this,\''+q.id+'\',true)">‚úÖ Richtig</div>';
    html+='<div class="tf-btn" onclick="answerTF(this,\''+q.id+'\',false)">‚ùå Falsch</div></div>';
  } else if(q.type==='fill'){
    let parts=q.q.split(/\{(\d+)\}/g);
    html='<div class="q-badges">';
    html+='<span class="badge badge-topic">'+TOPICS[q.topic].short+'</span>';
    html+='<span class="badge badge-diff'+q.diff+'">'+DIFF_LABELS[q.diff]+'</span>';
    html+='<span class="badge badge-tax">'+q.tax+'</span>';
    html+='<span class="badge badge-type">'+TYPE_LABELS[q.type]+'</span>';
    html+='</div>';
    html+='<div class="q-text">';
    let bIdx=0;
    for(let i=0;i<parts.length;i++){
      if(i%2===0)html+=parts[i];
      else html+='<input class="fill-input" data-bidx="'+bIdx+'" placeholder="‚Ä¶" autocomplete="off" autocapitalize="off">';
      if(i%2===1)bIdx++;
    }
    html+='</div><button class="btn btn-primary" style="margin-top:14px" onclick="answerFill(\''+q.id+'\')">√úberpr√ºfen</button>';
  } else if(q.type==='calc'){
    html+='<div class="calc-rows">';
    q.rows.forEach((r,i)=>{
      html+='<div class="calc-row"><label>'+r.label+'</label><input type="number" step="any" data-ridx="'+i+'" placeholder="?"><span class="unit">'+r.unit+'</span></div>';
    });
    html+='</div><button class="btn btn-primary" style="margin-top:14px" onclick="answerCalc(\''+q.id+'\')">√úberpr√ºfen</button>';
  } else if(q.type==='sort'){
    html+='<div class="sort-pool" id="sortPool">';
    let items=[...q.items];shuffle(items);
    items.forEach((it,i)=>{
      html+='<span class="sort-item" data-oidx="'+q.items.indexOf(it)+'" onclick="pickSortItem(this)">'+it.t+'</span>';
    });
    html+='</div><div class="sort-cats" id="sortCats" style="grid-template-columns:repeat('+q.categories.length+',1fr)">';
    q.categories.forEach((cat,ci)=>{
      html+='<div class="sort-cat" data-cidx="'+ci+'" onclick="placeSortItem(this,'+ci+')"><div class="sort-cat-title">'+cat+'</div><div class="sort-cat-items" id="sortCat'+ci+'"></div></div>';
    });
    html+='</div><button class="btn btn-primary" style="margin-top:14px" onclick="answerSort(\''+q.id+'\')">√úberpr√ºfen</button>';
  } else if(q.type==='open'){
    html+='<textarea class="open-answer" id="openAnswer" placeholder="Schreiben Sie Ihre Antwort hier‚Ä¶"></textarea>';
    html+='<button class="btn btn-primary" style="margin-top:14px" onclick="showOpenSample(\''+q.id+'\')">L√∂sung anzeigen</button>';
    html+='<div class="open-sample" id="openSample"><div class="open-sample-title">L√∂sungsvorschlag:</div><div id="openSampleText"></div></div>';
    html+='<div class="open-self" id="openSelf">';
    html+='<button class="btn btn-primary" onclick="answerOpen(\''+q.id+'\',true)">‚úÖ Gewusst</button>';
    html+='<button class="btn btn-outline" onclick="answerOpen(\''+q.id+'\',false)">‚ùå Nicht gewusst</button>';
    html+='</div>';
  }
  html+='<div class="feedback" id="feedback"></div>';
  document.getElementById('questionCard').innerHTML=html;
  pickedSortItem=null;
}

// ‚îÄ‚îÄ Answer handlers ‚îÄ‚îÄ
function answerMC(el,qid,val){
  if(document.querySelector('.mc-opt.correct,.mc-opt.wrong'))return;
  const q=QUESTIONS.find(x=>x.id===qid);
  document.querySelectorAll('.mc-opt').forEach(o=>{
    o.style.pointerEvents='none';
    if(o.dataset.val===q.correct)o.classList.add('correct');
    else if(o.dataset.val===val)o.classList.add('wrong');
  });
  finishAnswer(q,val===q.correct,q.explain);
}

function answerTF(el,qid,val){
  if(document.querySelector('.tf-btn.correct,.tf-btn.wrong'))return;
  const q=QUESTIONS.find(x=>x.id===qid);
  const correct=val===q.correct;
  document.querySelectorAll('.tf-btn').forEach(b=>b.style.pointerEvents='none');
  el.classList.add(correct?'correct':'wrong');
  if(!correct)document.querySelectorAll('.tf-btn').forEach(b=>{if(b!==el)b.classList.add('correct')});
  finishAnswer(q,correct,q.explain);
}

function answerFill(qid){
  const q=QUESTIONS.find(x=>x.id===qid);
  const inputs=document.querySelectorAll('.fill-input');
  let allCorrect=true;
  inputs.forEach(inp=>{
    const bi=parseInt(inp.dataset.bidx);
    const blank=q.blanks[bi];
    const userVal=inp.value.trim().toLowerCase();
    const ok=userVal===blank.answer.toLowerCase()||blank.alts.some(a=>userVal===a.toLowerCase());
    inp.classList.add(ok?'correct':'wrong');
    inp.disabled=true;
    if(!ok){allCorrect=false;inp.value=inp.value+' ‚Üí '+blank.answer}
  });
  finishAnswer(q,allCorrect,q.explain);
}

function answerCalc(qid){
  const q=QUESTIONS.find(x=>x.id===qid);
  const inputs=document.querySelectorAll('.calc-row input');
  let allCorrect=true;
  inputs.forEach(inp=>{
    const ri=parseInt(inp.dataset.ridx);
    const row=q.rows[ri];
    const val=parseFloat(inp.value);
    const ok=!isNaN(val)&&Math.abs(val-row.answer)<=row.tolerance;
    inp.classList.add(ok?'correct':'wrong');
    inp.disabled=true;
    if(!ok){allCorrect=false;inp.value=inp.value+' ‚Üí '+row.answer}
  });
  finishAnswer(q,allCorrect,q.explain);
}

function pickSortItem(el){
  if(el.classList.contains('placed'))return;
  document.querySelectorAll('.sort-item').forEach(s=>s.classList.remove('picked'));
  el.classList.add('picked');
  pickedSortItem=el;
}

function placeSortItem(catEl,cidx){
  if(!pickedSortItem)return;
  const container=catEl.querySelector('.sort-cat-items');
  const clone=document.createElement('span');
  clone.className='sort-cat-item';
  clone.textContent=pickedSortItem.textContent;
  clone.dataset.oidx=pickedSortItem.dataset.oidx;
  clone.onclick=function(){this.remove();
    const orig=document.querySelector('.sort-item[data-oidx="'+this.dataset.oidx+'"]');
    if(orig){orig.style.display='';orig.classList.remove('placed')}
  };
  container.appendChild(clone);
  pickedSortItem.style.display='none';
  pickedSortItem.classList.add('placed');
  pickedSortItem.classList.remove('picked');
  pickedSortItem=null;
}

function answerSort(qid){
  const q=QUESTIONS.find(x=>x.id===qid);
  let allCorrect=true;
  document.querySelectorAll('.sort-cat').forEach(catEl=>{
    const cidx=parseInt(catEl.dataset.cidx);
    catEl.querySelectorAll('.sort-cat-item').forEach(item=>{
      const oidx=parseInt(item.dataset.oidx);
      const ok=q.items[oidx].cat===cidx;
      item.classList.add(ok?'correct-item':'wrong-item');
      if(!ok)allCorrect=false;
    });
  });
  document.querySelectorAll('.sort-item').forEach(s=>s.style.pointerEvents='none');
  document.querySelectorAll('.sort-cat').forEach(c=>c.style.pointerEvents='none');
  document.querySelectorAll('#questionCard .btn-primary').forEach(b=>b.style.display='none');
  finishAnswer(q,allCorrect,q.explain);
}

function showOpenSample(qid){
  const q=QUESTIONS.find(x=>x.id===qid);
  document.getElementById('openSampleText').textContent=q.sample;
  document.getElementById('openSample').classList.add('show');
  document.getElementById('openSelf').classList.add('show');
  document.querySelectorAll('#questionCard .btn-primary').forEach(b=>{if(b.textContent.includes('L√∂sung'))b.style.display='none'});
}

function answerOpen(qid,correct){
  const q=QUESTIONS.find(x=>x.id===qid);
  document.getElementById('openSelf').style.display='none';
  document.getElementById('openAnswer').disabled=true;
  finishAnswer(q,correct,q.explain);
}

function finishAnswer(q,correct,explain){
  state.maxScore++;
  if(correct)state.score++;
  else state.wrong.push({q:q.q,explain:q.explain,topic:q.topic});
  state.answered.push({id:q.id,correct});
  document.getElementById('qScore').textContent=state.score+' Punkte';
  const fb=document.getElementById('feedback');
  fb.className='feedback show '+(correct?'correct':'wrong');
  fb.innerHTML='<div class="feedback-title">'+(correct?'‚úÖ Richtig!':'‚ùå Leider falsch')+'</div><div>'+explain+'</div>';
  document.getElementById('nextBtn').style.display='inline-flex';
}

function nextQuestion(){
  state.current++;
  if(state.current>=state.queue.length)return endQuiz();
  renderQuestion();
}

function endQuiz(){
  document.getElementById('progressBar').style.width='100%';
  showScreen('resultScreen');
  const pct=state.maxScore?Math.round(state.score/state.maxScore*100):0;
  document.getElementById('resPts').textContent=state.score+' / '+state.maxScore;
  document.getElementById('resPct').textContent=pct+'%';
  let topicData={};
  state.queue.forEach((q,i)=>{
    if(i>=state.answered.length)return;
    if(!topicData[q.topic])topicData[q.topic]={correct:0,total:0};
    topicData[q.topic].total++;
    if(state.answered[i].correct)topicData[q.topic].correct++;
  });
  let tHtml='';
  Object.keys(topicData).forEach(t=>{
    const d=topicData[t];const p=Math.round(d.correct/d.total*100);
    const cls=p>=70?'tg':p>=40?'ty':'tr';
    tHtml+='<div class="topic-row"><span class="topic-name">'+TOPICS[t].label+'</span>';
    tHtml+='<span class="topic-score">'+d.correct+'/'+d.total+'</span>';
    tHtml+='<div class="topic-bar"><div class="topic-bar-fill '+cls+'" style="width:'+p+'%"></div></div></div>';
  });
  document.getElementById('topicResults').innerHTML=tHtml;

  // Build full review of all questions
  let rHtml='';
  state.queue.forEach((q,i)=>{
    if(i>=state.answered.length) return;
    const a=state.answered[i];
    const cls=a.correct?'ri-correct':'ri-wrong';
    const icon=a.correct?'‚úÖ':'‚ùå';
    rHtml+='<div class="review-item '+cls+'">';
    rHtml+='<div class="ri-header"><span class="ri-num">#'+(i+1)+'</span><span class="ri-icon">'+icon+'</span>';
    rHtml+='<span class="ri-topic">'+TOPICS[q.topic].short+'</span></div>';
    rHtml+='<div class="ri-question">'+getQuestionDisplay(q)+'</div>';
    rHtml+='<div class="ri-answer"><strong>L√∂sung:</strong> '+getCorrectAnswer(q)+'</div>';
    rHtml+='<div class="ri-explain">'+q.explain+'</div>';
    rHtml+='</div>';
  });
  document.getElementById('reviewList').innerHTML=rHtml;
}

function getQuestionDisplay(q){
  if(q.type==='fill'){
    // Replace {0},{1},‚Ä¶ placeholders with the correct answers in bold
    return q.q.replace(/\{(\d+)\}/g,function(_,idx){
      const b=q.blanks[parseInt(idx)];
      return b?'<strong>['+b.answer+']</strong>':'[‚Ä¶]';
    });
  }
  return q.q;
}

function getCorrectAnswer(q){
  if(q.type==='mc'){
    const opt=q.options.find(o=>o.v===q.correct);
    return q.correct+') '+(opt?opt.t:'');
  }
  if(q.type==='tf'){
    return q.correct?'Richtig':'Falsch';
  }
  if(q.type==='fill'){
    return q.blanks.map(function(b,i){return 'L√ºcke '+(i+1)+': '+b.answer}).join(' ¬∑ ');
  }
  if(q.type==='calc'){
    return q.rows.map(function(r){return r.label+' '+r.answer+' '+r.unit}).join(' ¬∑ ');
  }
  if(q.type==='sort'){
    return q.categories.map(function(cat,ci){
      const items=q.items.filter(function(it){return it.cat===ci}).map(function(it){return it.t});
      return '<strong>'+cat+':</strong> '+items.join(', ');
    }).join(' ¬∑ ');
  }
  if(q.type==='open'){
    return q.sample||'Siehe L√∂sungsvorschlag';
  }
  return '';
}

function exportResults(){
  document.getElementById('printTitle').textContent=POOL_META.title;
  const now=new Date();
  document.getElementById('printMeta').textContent=POOL_META.meta+' ¬∑ '+now.toLocaleDateString('de-CH',{day:'2-digit',month:'2-digit',year:'numeric'})+', '+now.toLocaleTimeString('de-CH',{hour:'2-digit',minute:'2-digit'});
  window.print();
}

function resetApp(){
  state={mode:null,filters:{topics:new Set(),diffs:new Set(),types:new Set()},queue:[],current:0,score:0,maxScore:0,answered:[],wrong:[]};
  document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
  document.querySelectorAll('.mode-card').forEach(c=>c.classList.remove('active'));
  updateFilterCount();
  showScreen('startScreen');
}

function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo({top:0});
}

function shuffle(arr){for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]]}return arr}
</script>
</body>
</html>
